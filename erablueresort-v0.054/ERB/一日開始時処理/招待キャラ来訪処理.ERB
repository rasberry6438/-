@招待キャラ来訪処理
#DIM 同行キャラ可能枠
#DIM 部屋番号
#DIM 招待キャラ
#DIM 同行キャラ
#DIM 同行確率
#DIM 持ち越し番号
#DIM 招待L_CNT
#DIM 同行L_CNT
#DIM 同行判定値
#DIM 滞在期間基本日数
#DIM 滞在期間補正日数
#DIM 持ち越し処理キャラ配列, VARSIZE("持ち越しキャラ招待")
#DIM CONST 滞在期間下限値 = 1 + 1 ;[日] 来訪処理→滞在期間減算の順で処理するので+1日する

;まず持ち越し処理キャラ配列に前日からの持ち越しキャラを突っ込む
VARSET 持ち越し処理キャラ配列
ARRAYCOPY "持ち越しキャラ招待", "持ち越し処理キャラ配列"
VARSET 持ち越しキャラ招待

;招待キャラがいる場合、滞在期間を増やす
;基本的に５日～７日くらい？　後々調整する

;スイートルーム招待処理
;滞在者上限に引っかからないため、先に処理する
FOR 部屋番号, 0, スイートルーム部屋数
	招待キャラ = スイートルーム招待:部屋番号
	IF スイートルーム招待:部屋番号 > 0
		;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
		SIF CFLAG:招待キャラ:滞在期間 > 0
			CONTINUE
		;滞在期間の算出
		CALL 滞在期間基本日数算出(招待キャラ)
		滞在期間基本日数 = RESULT
		;無料招待は滞在期間の補正なし
		;CALL 滞在期間補正日数算出(招待キャラ)
		滞在期間補正日数 = 0
		CFLAG:招待キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
		CFLAG:招待キャラ:リゾート来訪回数 += 1
		CFLAG:招待キャラ:スイートルーム滞在フラグ = 100 + 部屋番号
		PRINTFORML %CALLNAME:招待キャラ%接受免费邀请来到度假村！
		スイートルーム部屋割り配列:部屋番号 = _{招待キャラ}
		BASE:招待キャラ:体力 = MAXBASE:招待キャラ:体力
		CFLAG:招待キャラ:現在マップ種別 = 999
		CFLAG:招待キャラ:現在位置 = 部屋番号 + 2000
		CALL 招待時妊娠メッセージ(招待キャラ)
		IF 初体験日:招待キャラ:リゾート初来訪 == 0
			初体験日:招待キャラ:リゾート初来訪 = DAY
			CALL 履歴データベース登録(CFLAG:招待キャラ:人物番号, @"初次访问度假村","日常")
		ENDIF
		;こっから同行キャラ判定、禁止モードの時は読まない
		IF スイートルーム招待モード == 0
			FOR 同行L_CNT, 0, 100
				同行キャラ = 同行候補キャラ番号:招待キャラ:同行L_CNT
				同行確率   = 同行候補キャラ確率:招待キャラ:同行L_CNT
				SIF 同行キャラ < 1
					BREAK
				SIF CFLAG:同行キャラ:招待不可フラグ != 0
					CONTINUE
				;オプションによる制御
				SIF 性別招待制御_実処理(同行キャラ)
					CONTINUE
				同行判定値 = RAND:100
				IF 同行確率 > 同行判定値
					;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
					SIF CFLAG:同行キャラ:滞在期間 > 0
						CONTINUE
					;無料招待は滞在期間の補正なし
					;CALL 滞在期間補正日数算出(招待キャラ)
					滞在期間補正日数 = 0
					CFLAG:同行キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
					CFLAG:同行キャラ:リゾート来訪回数 += 1
					CFLAG:同行キャラ:スイートルーム滞在フラグ =  100 + 部屋番号
					PRINTFORML 　%CALLNAME:招待キャラ%与同行者%CALLNAME:同行キャラ%一同造访度假村
					IF 初体験日:同行キャラ:リゾート初来訪 == 0
						初体験日:同行キャラ:リゾート初来訪 = DAY
						CALL 履歴データベース登録(CFLAG:同行キャラ:人物番号, @"初次访问度假村","日常")
					ENDIF
					スイートルーム部屋割り配列:部屋番号 += @"_{同行キャラ}"
					BASE:同行キャラ:体力 = MAXBASE:同行キャラ:体力
					CFLAG:同行キャラ:現在マップ種別 = 999
					CFLAG:同行キャラ:現在位置 = 部屋番号 + 2000
					CALL 招待時妊娠メッセージ(同行キャラ)
				ENDIF
			NEXT
		ENDIF
		;無料招待は恋慕による滞在期間延長なし
		スイートルーム部屋割り配列:部屋番号 += "_"
	ENDIF
NEXT
CALL 招待時妊娠メッセージ(0,1)
VARSET スイートルーム招待

持ち越し番号 = 0
;同行キャラが入れる枠を計算
CALL ユニーク客人数チェック()
同行キャラ可能枠 = 滞在キャラ上限 - 滞在キャラ数 - 集客人数

IF 通常キャラ招待:0 > 0
	FOR 招待L_CNT, 0, 10
		招待キャラ = 通常キャラ招待:招待L_CNT
		;値が１万だと特别招待券と被ってる証拠
		SIF 招待キャラ == 10000
			CONTINUE
		SIF 招待キャラ == 0
			BREAK
		;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
		SIF CFLAG:招待キャラ:滞在期間 > 0
			CONTINUE
		CALL 滞在者部屋割り配列挿入処理(招待キャラ)
		;部屋がいっぱいで失敗した場合はスルーして持ち越し配列へ
		IF RESULT == 0
			IF 持ち越し番号 < VARSIZE("持ち越しキャラ招待")
				持ち越しキャラ招待:持ち越し番号 = 招待キャラ
				持ち越し番号 ++
			ENDIF
			CONTINUE
		ENDIF
		;滞在期間の算出
		CALL 滞在期間基本日数算出(招待キャラ)
		滞在期間基本日数 = RESULT
		CALL 滞在期間補正日数算出(招待キャラ)
		滞在期間補正日数 = RESULT
		CFLAG:招待キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
		CFLAG:招待キャラ:リゾート来訪回数 += 1
		PRINTFORML %CALLNAME:招待キャラ%现身度假村
		BASE:招待キャラ:体力 = MAXBASE:招待キャラ:体力
		CALL 招待時妊娠メッセージ(招待キャラ)
		IF 初体験日:招待キャラ:リゾート初来訪 == 0
			初体験日:招待キャラ:リゾート初来訪 = DAY
			CALL 履歴データベース登録(CFLAG:招待キャラ:人物番号, @"初次访问度假村","日常")
		ENDIF
		;こっから同行キャラ判定
		IF 同行キャラ可能枠 > 0
			FOR 同行L_CNT, 0, 100
				同行キャラ = 同行候補キャラ番号:招待キャラ:同行L_CNT
				同行確率   = 同行候補キャラ確率:招待キャラ:同行L_CNT
				SIF 同行キャラ可能枠 <= 0
					BREAK
				SIF 同行キャラ < 1
					BREAK
				SIF CFLAG:同行キャラ:招待不可フラグ != 0
					CONTINUE
				;オプションによる制御
				SIF 性別招待制御_実処理(同行キャラ)
					CONTINUE
				同行判定値 = RAND:100
				;通常招待のみ、団体客広告フラグの影響を受ける
				SIF 団体客広告フラグ
					同行判定値 = 同行判定値 * 2 / 3
				IF 同行確率 > 同行判定値
					;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
					SIF CFLAG:同行キャラ:滞在期間 > 0
						CONTINUE
					CALL 滞在期間補正日数算出(同行キャラ)
					滞在期間補正日数 = RESULT
					CFLAG:同行キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
					CFLAG:同行キャラ:リゾート来訪回数 += 1
					PRINTFORML 　%CALLNAME:招待キャラ%与同行者%CALLNAME:同行キャラ%一同造访度假村
					BASE:同行キャラ:体力 = MAXBASE:同行キャラ:体力
					IF 初体験日:同行キャラ:リゾート初来訪 == 0
						初体験日:同行キャラ:リゾート初来訪 = DAY
						CALL 履歴データベース登録(CFLAG:同行キャラ:人物番号, @"初次访问度假村","日常")
					ENDIF
					CALL 滞在者部屋割り配列挿入処理(同行キャラ)
					CALL 招待時妊娠メッセージ(同行キャラ)
					同行キャラ可能枠 -= 1
				ENDIF
			NEXT
		ENDIF
	NEXT
	CALL 招待時妊娠メッセージ(0,1)
ENDIF
VARSET 通常キャラ招待

IF 解放キャラ招待:0 > 0
	FOR 招待L_CNT, 0, 100
		招待キャラ = 解放キャラ招待:招待L_CNT
		SIF 招待キャラ == 0
			BREAK
		;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
		SIF CFLAG:招待キャラ:滞在期間 > 0
			CONTINUE
		CALL 滞在者部屋割り配列挿入処理(招待キャラ)
		;部屋がいっぱいで失敗した場合はスルー
		IF RESULT == 0
			IF 持ち越し番号 < VARSIZE("持ち越しキャラ招待")
				持ち越しキャラ招待:持ち越し番号 = 招待キャラ
				持ち越し番号 ++
			ENDIF
			CONTINUE
		ENDIF
		;滞在期間の算出
		CALL 滞在期間基本日数算出(招待キャラ)
		滞在期間基本日数 = RESULT
		CALL 滞在期間補正日数算出(招待キャラ)
		滞在期間補正日数 = RESULT
		CFLAG:招待キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
		CFLAG:招待キャラ:リゾート来訪回数 += 1
		PRINTFORML %CALLNAME:招待キャラ%受引导来到度假村
		BASE:招待キャラ:体力 = MAXBASE:招待キャラ:体力
		CALL 招待時妊娠メッセージ(招待キャラ)
		IF 初体験日:招待キャラ:リゾート初来訪 == 0
			初体験日:招待キャラ:リゾート初来訪 = DAY
			CALL 履歴データベース登録(CFLAG:招待キャラ:人物番号, @"初次访问度假村","日常")
		ENDIF
		;こっから同行キャラ判定
		IF 同行キャラ可能枠 > 0
			FOR 同行L_CNT, 0, 100
				同行キャラ = 同行候補キャラ番号:招待キャラ:同行L_CNT
				同行確率   = 同行候補キャラ確率:招待キャラ:同行L_CNT
				SIF 同行キャラ可能枠 <= 0
					BREAK
				SIF 同行キャラ < 1
					BREAK
				SIF CFLAG:同行キャラ:招待不可フラグ != 0
					CONTINUE
				;オプションによる制御
				SIF 性別招待制御_実処理(同行キャラ)
					CONTINUE
				同行判定値 = RAND:100
				IF 同行確率 > 同行判定値
					;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
					SIF CFLAG:同行キャラ:滞在期間 > 0
						CONTINUE
					CALL 滞在期間補正日数算出(同行キャラ)
					滞在期間補正日数 = RESULT
					CFLAG:同行キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
					CFLAG:同行キャラ:リゾート来訪回数 += 1
					PRINTFORML 　%CALLNAME:招待キャラ%与同行者%CALLNAME:同行キャラ%一同造访度假村
					BASE:同行キャラ:体力 = MAXBASE:同行キャラ:体力
					IF 初体験日:同行キャラ:リゾート初来訪 == 0
						初体験日:同行キャラ:リゾート初来訪 = DAY
						CALL 履歴データベース登録(CFLAG:同行キャラ:人物番号, @"初次访问度假村","日常")
					ENDIF
					CALL 滞在者部屋割り配列挿入処理(同行キャラ)
					CALL 招待時妊娠メッセージ(同行キャラ)
					同行キャラ可能枠 -= 1
				ENDIF
			NEXT
		ENDIF
	NEXT
	CALL 招待時妊娠メッセージ(0,1)
ENDIF
VARSET 解放キャラ招待

IF ＤＭキャラ招待
	招待キャラ = ABS(ＤＭキャラ招待)
	IF ＤＭキャラ招待 < 0
		;招待失敗
		PRINTFORML %CALLNAME:招待キャラ%因故未能前来…
	ELSEIF ＤＭキャラ招待 > 0
		CALL 滞在者部屋割り配列挿入処理(招待キャラ)
		;部屋がいっぱいで失敗した場合はスルー
		IF RESULT == 0
			PRINTFORML %CALLNAME:招待キャラ%因故未能前来…
		ELSE
			PRINTFORML %CALLNAME:招待キャラ%受邀来到度假村！
			BASE:招待キャラ:体力 = MAXBASE:招待キャラ:体力
			;滞在期間の算出
			CALL 滞在期間基本日数算出(招待キャラ)
			滞在期間基本日数 = RESULT
			CALL 滞在期間補正日数算出(招待キャラ)
			滞在期間補正日数 = RESULT
			CFLAG:招待キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
			CFLAG:招待キャラ:リゾート来訪回数 += 1
			CALL 招待時妊娠メッセージ(招待キャラ)
			;こっから同行キャラ判定
			IF 同行キャラ可能枠 > 0
				FOR 同行L_CNT, 0, 100
					同行キャラ = 同行候補キャラ番号:招待キャラ:同行L_CNT
					同行確率   = 同行候補キャラ確率:招待キャラ:同行L_CNT
					SIF 同行キャラ可能枠 <= 0
						BREAK
					SIF 同行キャラ < 1
						BREAK
					SIF CFLAG:同行キャラ:招待不可フラグ != 0
						CONTINUE
					;オプションによる制御
					SIF 性別招待制御_実処理(同行キャラ)
						CONTINUE
					同行判定値 = RAND:100
					IF 同行確率 > 同行判定値
						;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
						SIF CFLAG:同行キャラ:滞在期間 > 0
							CONTINUE
						CALL 滞在期間補正日数算出(同行キャラ)
						滞在期間補正日数 = RESULT
						CFLAG:同行キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
						CFLAG:同行キャラ:リゾート来訪回数 += 1
						PRINTFORML 　%CALLNAME:招待キャラ%与同行者%CALLNAME:同行キャラ%持特别票券造访度假村！
						BASE:同行キャラ:体力 = MAXBASE:同行キャラ:体力
						IF 初体験日:同行キャラ:リゾート初来訪 == 0
							初体験日:同行キャラ:リゾート初来訪 = DAY
							CALL 履歴データベース登録(CFLAG:同行キャラ:人物番号, @"初次访问度假村","日常")
						ENDIF
						CALL 滞在者部屋割り配列挿入処理(同行キャラ)
						CALL 招待時妊娠メッセージ(同行キャラ)
						同行キャラ可能枠 -= 1
					ENDIF
				NEXT
			ENDIF
			CALL 招待時妊娠メッセージ(0,1)
		ENDIF
	ENDIF
ENDIF
ＤＭキャラ招待 = 0


IF 特别招待券キャラ招待
	招待キャラ = 特别招待券キャラ招待
	CALL 滞在者部屋割り配列挿入処理(招待キャラ)
	;部屋がいっぱいで失敗した場合はスルー
	IF RESULT == 1
		PRINTFORML %CALLNAME:招待キャラ%持特别招待券造访度假村！
		BASE:招待キャラ:体力 = MAXBASE:招待キャラ:体力
		CALL 招待時妊娠メッセージ(招待キャラ)
		;滞在期間の算出
		CALL 滞在期間基本日数算出(招待キャラ)
		滞在期間基本日数 = RESULT
		CALL 滞在期間補正日数算出(招待キャラ)
		滞在期間補正日数 = RESULT
		CFLAG:招待キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
		CFLAG:招待キャラ:リゾート来訪回数 += 1
		;こっから同行キャラ判定
		IF 同行キャラ可能枠 > 0
			FOR 同行L_CNT, 0, 100
				同行キャラ = 同行候補キャラ番号:招待キャラ:同行L_CNT
				同行確率   = 同行候補キャラ確率:招待キャラ:同行L_CNT
				SIF 同行キャラ可能枠 <= 0
					BREAK
				SIF 同行キャラ < 1
					BREAK
				SIF CFLAG:同行キャラ:招待不可フラグ != 0
					CONTINUE
				;オプションによる制御
				SIF 性別招待制御_実処理(同行キャラ)
					CONTINUE
				同行判定値 = RAND:100
				IF 同行確率 > 同行判定値
					;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
					SIF CFLAG:同行キャラ:滞在期間 > 0
						CONTINUE
					CALL 滞在期間補正日数算出(同行キャラ)
					滞在期間補正日数 = RESULT
					CFLAG:同行キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
					CFLAG:同行キャラ:リゾート来訪回数 += 1
					PRINTFORML 　%CALLNAME:招待キャラ%与同行者%CALLNAME:同行キャラ%持特别票券造访度假村！
					BASE:同行キャラ:体力 = MAXBASE:同行キャラ:体力
					IF 初体験日:同行キャラ:リゾート初来訪 == 0
						初体験日:同行キャラ:リゾート初来訪 = DAY
						CALL 履歴データベース登録(CFLAG:同行キャラ:人物番号, @"初次访问度假村","日常")
					ENDIF
					CALL 滞在者部屋割り配列挿入処理(同行キャラ)
					CALL 招待時妊娠メッセージ(同行キャラ)
					同行キャラ可能枠 -= 1
				ENDIF
			NEXT
		ENDIF
		CALL 招待時妊娠メッセージ(0,1)
	ENDIF
ENDIF

;通常招待用の変数リセット
特别招待券キャラ招待 = 0
集客人数 = 0
団体客広告フラグ = 0
FLAG:滞在キャラ枠先確保分 = 0
CALL ユニーク客人数チェック()

;最後に持ち越しキャラの判定
同行キャラ可能枠 = 滞在キャラ上限 - 滞在キャラ数
IF 持ち越し処理キャラ配列:0 > 0
	FOR 招待L_CNT, 0, 10
		招待キャラ = 持ち越し処理キャラ配列:招待L_CNT
		SIF 招待キャラ == 0
			BREAK
		;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
		SIF CFLAG:招待キャラ:滞在期間 > 0
			CONTINUE
		CALL 滞在者部屋割り配列挿入処理(招待キャラ)
		;部屋がいっぱいで失敗した場合はスルー
		IF RESULT == 0
			CONTINUE
		ENDIF
		;滞在期間の算出
		CALL 滞在期間基本日数算出(招待キャラ)
		滞在期間基本日数 = RESULT
		CALL 滞在期間補正日数算出(招待キャラ)
		滞在期間補正日数 = RESULT
		CFLAG:招待キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
		CFLAG:招待キャラ:リゾート来訪回数 += 1
		PRINTFORML %CALLNAME:招待キャラ%现身度假村
		BASE:招待キャラ:体力 = MAXBASE:招待キャラ:体力
		CALL 招待時妊娠メッセージ(招待キャラ)
		IF 初体験日:招待キャラ:リゾート初来訪 == 0
			初体験日:招待キャラ:リゾート初来訪 = DAY
			CALL 履歴データベース登録(CFLAG:招待キャラ:人物番号, @"初次访问度假村","日常")
		ENDIF
		;こっから同行キャラ判定
		IF 同行キャラ可能枠 > 0
			FOR 同行L_CNT, 0, 100
				同行キャラ = 同行候補キャラ番号:招待キャラ:同行L_CNT
				同行確率   = 同行候補キャラ確率:招待キャラ:同行L_CNT
				SIF 同行キャラ可能枠 <= 0
					BREAK
				SIF 同行キャラ < 1
					BREAK
				SIF CFLAG:同行キャラ:招待不可フラグ != 0
					CONTINUE
				;オプションによる制御
				SIF 性別招待制御_実処理(同行キャラ)
					CONTINUE
				同行判定値 = RAND:100
				;通常招待のみ、団体客広告フラグの影響を受ける
				SIF 団体客広告フラグ
					同行判定値 = 同行判定値 * 2 / 3
				IF 同行確率 > 同行判定値
					;同行キャラ処理の都合で招待キャラが被る可能性があるため、既に滞在期間があるキャラはスルー
					SIF CFLAG:同行キャラ:滞在期間 > 0
						CONTINUE
					CALL 滞在期間補正日数算出(同行キャラ)
					滞在期間補正日数 = RESULT
					CFLAG:同行キャラ:滞在期間 = MAX(滞在期間基本日数 + 滞在期間補正日数, 滞在期間下限値)
					CFLAG:同行キャラ:リゾート来訪回数 += 1
					PRINTFORML 　%CALLNAME:招待キャラ%与同行者%CALLNAME:同行キャラ%一同造访度假村
					BASE:同行キャラ:体力 = MAXBASE:同行キャラ:体力
					IF 初体験日:同行キャラ:リゾート初来訪 == 0
						初体験日:同行キャラ:リゾート初来訪 = DAY
						CALL 履歴データベース登録(CFLAG:同行キャラ:人物番号, @"初次访问度假村","日常")
					ENDIF
					CALL 滞在者部屋割り配列挿入処理(同行キャラ)
					CALL 招待時妊娠メッセージ(同行キャラ)
					同行キャラ可能枠 -= 1
				ENDIF
			NEXT
		ENDIF
	NEXT
	CALL 招待時妊娠メッセージ(0,1)
ENDIF
VARSET 持ち越し処理キャラ配列

RETURN 0
