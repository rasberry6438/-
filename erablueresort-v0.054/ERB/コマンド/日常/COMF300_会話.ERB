
@COMNAME300
#FUNCTIONS
TSTR:コマンド名受渡 = 对话

;===================================================
;コマンドタイプ
;===================================================
@COMTYPE_300
#FUNCTION
TFLAG:コマンドタイプ受渡 = COMTYPE("日常_飲み会")

@COM_TOOLTIP_300
LOCALS = <br>■对话<br>
LOCALS += "进行日常闲聊的指令。根据概率分为大成功、成功、失败三种结果。<br>短时间内频繁使用会导致话题枯竭而失败。<br>目标拥有「爱慕」特质的情况，或在酒会期间可无视此限制。"
LOCALS += "<br>指令类型：日常<br>获取来源：欢乐・征服"
LOCALS += "<br>专属经验值：对话经验(MASTER)<br>"
TSTR:ツールチップ受渡 = %LOCALS%


@COM300
;会話

;会話累積値が閾値を超えると失敗
IF TCVAR:話題無しフラグ && !TALENT:恋慕 && TFLAG:調教モード != 3
	PRINTFORML 试图与%CALLNAME:TARGET%搭话却找不到合适话题
	PRINTW 周遭弥漫着尴尬的气氛…
	TIME += 10
	;口上分岐としてはここは大失敗扱いがいいんじゃないかな
	RFLAG:コマンド結果受渡し変数 = -2
	RETURN 0
ENDIF

LOCAL = RAND:100
LOCAL:1 = 90 + GET_SUCCESS_RATE() / 5
SIF LOCAL:1 > 99
	LOCAL:1 = 99
IF LOCAL <= 9
	;10％で大成功
	RFLAG:コマンド結果受渡し変数 = 1
	EXP:MASTER:会話経験 ++
ELSEIF LOCAL >= LOCAL:1
	;10～1％で失敗
	RFLAG:コマンド結果受渡し変数 = -1
ELSE
	;残りは成功
	RFLAG:コマンド結果受渡し変数 = 0
ENDIF


;歓楽強度
LOCAL:0 = 300
;征服強度
LOCAL:1 = 50

IF RFLAG:コマンド結果受渡し変数 == -1
	TIMES LOCAL:0 , 0.10
	TIMES LOCAL:1 , 0.50
ELSEIF RFLAG:コマンド結果受渡し変数 == 0
	TIMES LOCAL:0 , 1.00
	TIMES LOCAL:1 , 1.00
ELSE
	TIMES LOCAL:0 , 2.00
	TIMES LOCAL:1 , 2.00
ENDIF
SELECTCASE ABL:MASTER:話術技能
	CASE 0
		TIMES LOCAL:0 , 0.20
		TIMES LOCAL:1 , 0.20
	CASE 1
		TIMES LOCAL:0 , 0.40
		TIMES LOCAL:1 , 0.40
	CASE 2
		TIMES LOCAL:0 , 0.70
		TIMES LOCAL:1 , 0.70
	CASE 3
		TIMES LOCAL:0 , 1.00
		TIMES LOCAL:1 , 1.00
	CASE 4
		TIMES LOCAL:0 , 1.50
		TIMES LOCAL:1 , 1.50
	CASEELSE
		TIMES LOCAL:0 , 2.00
		TIMES LOCAL:1 , 2.00
ENDSELECT


CALL SOURCE_CALC_歓楽(TARGET, PLAYER, LOCAL:0)
CALL SOURCE_CALC_征服(TARGET, PLAYER, LOCAL:1)
CALL SOURCE_CALC_好感度要素_友情度UP(TARGET, PLAYER, LOCAL:0 / 2)

;会話累積値
LOCAL = 200 - (TALENT:TARGET:会話資質 * 50) - (TALENT:PLAYER:会話資質 * 50)
TCVAR:会話累積値 += LOCAL / (3 + ABL:MASTER:話術技能 + TALENT:TARGET:陽気／陰気)

TIME += 15
EXP:MASTER:会話経験 ++
RETURN 1

;-------------------------------------------------
;実行判定
;-------------------------------------------------
@COM_ABLE300
;会話実行判定
SIF SAVESTR:ゲームフェイズ管理 != "通常モード"
	RETURN 0
;一括管理
SIF GLOBAL_COMABLE(300)
	RETURN RESULT
;睡眠中
SIF CFLAG:睡眠
	RETURN 0
;口を何かに使ってるなら無理
SIF TEQUIP:PLAYER:口
	RETURN 0
SIF TEQUIP:TARGET:口
	RETURN 0
RETURN 1

;-------------------------------------------------
;実行時メッセージ
;-------------------------------------------------
@MESSAGE_COM300
PRINTFORM %CALLNAME:PLAYER%与%CALLNAME:TARGET%
IF TALENT:恋慕
	PRINTDATA
		DATAFORM 十指相扣
		DATAFORM 并肩而坐
		DATAFORM 略带羞涩地
		DATAFORM \@ TIME >= 360 && TIME <= 1080 ? 在白天的阳光下 # 在深夜的静谧中 \@
		DATAFORM 嬉笑打闹着
		DATAFORM 相视而笑
	ENDDATA
ELSE
	PRINTDATA
		DATAFORM 家长里短的
		DATAFORM 漫无边际的
		DATAFORM 毫无营养的
		DATAFORM 幼稚可笑的
		DATAFORM 无关紧要的
		DATAFORM 略显生硬的
	ENDDATA
ENDIF
PRINTFORML 展开了对话
IF RFLAG:コマンド結果受渡し変数 == 1
	PRINTFORML 愉快的时光悄然流逝…
ELSEIF RFLAG:コマンド結果受渡し変数 == -1
	PRINTFORML 对话中断后尴尬的气氛弥漫…
ENDIF


