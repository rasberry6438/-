@ADD_CHECK_FALL_STATE(STATE, CHARA, ALLOWED_STATES, BIT_INDEX, DEFAULT_RESULT)
#DIMS STATE
#DIM CHARA
#DIM REF ALLOWED_STATES
#DIM BIT_INDEX
#DIM DEFAULT_RESULT
#DIM DYNAMIC VALID = 1
VARSET RESULT

CALL KOJO_CHECK(CHARA, "FALL_STATE_OVERRIDE", STATE)
IF RESULT == -1
    CLEARBIT ALLOWED_STATES, BIT_INDEX
    RETURN
ENDIF

SIF !RESULT
    VALID = DEFAULT_RESULT

IF VALID
    VARSET RESULT
    VARSET RESULTS
    CALL KOJO_CHECK(CHARA, "FALL_STATE", STATE)
    FOR LOCAL, 1, RESULT + 1
        VALID &= RESULT:LOCAL
    NEXT
ENDIF

SIF VALID
    SETBIT ALLOWED_STATES, BIT_INDEX

;Returns bitwise value containing which states are permitted
;0=Yearning,1=Love,2=Deep Love,3=Fuck Buddy,4=Lust
@ADD_CHECK_FALL_STATES(CHARA)
#DIM CHARA
#DIM DYNAMIC FALL_STATES_ALLOWED

SIF !(TALENT:CHARA:愛欲 || TALENT:CHARA:恋慕 || TALENT:CHARA:思慕); && !(TALENT:CHARA:セフレ && !FLAG:陥落路線変化)
    CALL ADD_CHECK_FALL_STATE("YEARNING", CHARA, FALL_STATES_ALLOWED, 0, 思慕取得条件(CHARA))
SIF !(TALENT:CHARA:恋慕 || (TALENT:CHARA:愛欲 && !FLAG:陥落路線変化))
    CALL ADD_CHECK_FALL_STATE("LOVE", CHARA, FALL_STATES_ALLOWED, 1, 恋慕取得条件(CHARA))
;todo enable
; SIF TALENT:CHARA:恋慕 == 1
;     CALL ADD_CHECK_FALL_STATE("DEEP LOVE", CHARA, FALL_STATES_ALLOWED, 2, TRUE_LOVE_CONDITIONS(CHARA))
SIF !(TALENT:CHARA:恋人 || TALENT:CHARA:恋慕 || TALENT:CHARA:セフレ == 2)    
    CALL ADD_CHECK_FALL_STATE("FUCK BUDDY", CHARA, FALL_STATES_ALLOWED, 3, 炮友取得条件(CHARA))
SIF !(TALENT:CHARA:恋慕 || TALENT:CHARA:愛欲 || TALENT:CHARA:セフレ == 0)
    CALL ADD_CHECK_FALL_STATE("LUST", CHARA, FALL_STATES_ALLOWED, 4, 愛欲取得条件(CHARA))

RETURN FALL_STATES_ALLOWED

@ADD_PRINT_FALL_STATES(STATE, CHARA)
#DIMS STATE
#DIM CHARA
VARSET RESULT
VARSET RESULTS

CALL KOJO_CHECK(CHARA, "FALL_STATE", STATE)
FOR LOCAL, 1, RESULT + 1
    PRINT 　
    CALL COND_COLORMESSAGE(RESULT:LOCAL, RESULTS:LOCAL)
NEXT

