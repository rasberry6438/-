@ZDHSZY_TW4945_TPP_K43
#DIM 接吻マーク反感
#DIM 欲求不満度上昇
#DIM 経験増加量
#DIM 体位保存
#DIM Ｖ性交保存
#DIM Ａ性交保存
#DIM PLAYER体位保存
#DIM PLAYERＶ性交保存
#DIM PLAYERＡ性交保存
#DIMS ゴム 
#DIM 中毒補正

CALL KOJO_MESSAGE_SEND("EXTRASOURCE", SELECTCOM, TARGET)

IF OAZUKE(TARGET)
	PRINTFORML %NAME_OUTPUT_TRANSLATION("CALLNAME", TARGET)%對“還不能去”的指令表示了不滿…
	SOURCE:反感 += 3000
	SOURCE:屈従 += 500
	SOURCE:恭順 -= 1500
ENDIF

CALL PEARL_CHK_MASTER

FOR LOCAL,0,CHARANUM
	接吻マーク反感 = 0
	SIF CFLAG:LOCAL:現在位置 == SUKIMA()
		CONTINUE
	;跳蛋挿入
	IF CFLAG:LOCAL:跳蛋挿入
		SOURCE:LOCAL:快Ｖ += TIME_PROGRESS(TIME:1) * 10
		CFLAG:LOCAL:跳蛋挿入 = MAX(CFLAG:LOCAL:跳蛋挿入 - TIME_PROGRESS(TIME:1),0)
		IF CFLAG:LOCAL:跳蛋挿入 == 0
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%装备着的跳蛋的电池没电了
			IF TALENT:LOCAL:処女 < 1
				EXP:LOCAL:Ｖ経験 += 9
			ELSE
				TFLAG:2 = 1
			ENDIF
		ENDIF
	ENDIF
	IF CFLAG:LOCAL:跳蛋A挿入
		SOURCE:LOCAL:快Ａ += TIME_PROGRESS(TIME:1) * 10
		CFLAG:LOCAL:跳蛋A挿入 = MAX(CFLAG:LOCAL:跳蛋A挿入 - TIME_PROGRESS(TIME:1),0)
		IF CFLAG:LOCAL:跳蛋A挿入 == 0
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%装备着的跳蛋的电池没电了
			EXP:LOCAL:Ａ経験 += 9
		ENDIF
	ENDIF
	IF TFLAG:接吻マーク && LOCAL > 0 && !TFLAG:绷帯 && !FLAG:70 && !CFLAG:LOCAL:睡眠
		IF CFLAG:LOCAL:現在位置 == CFLAG:MASTER:現在位置 && TFLAG:接吻マーク != LOCAL && !TFLAG:泡風呂
			PRINTFORMW %NAME_OUTPUT_TRANSLATION("CALLNAME", LOCAL)%看到%NAME_OUTPUT_TRANSLATION("CALLNAME", MASTER)%的吻痕后怪責了起來……
			IF TALENT:LOCAL:恋慕
				接吻マーク反感 = 500
			ELSEIF TALENT:LOCAL:思慕
				接吻マーク反感 = 300
			ENDIF
			接吻マーク反感 = 接吻マーク反感 * (TALENT:LOCAL:貞操 + 2) / 2
			SOURCE:LOCAL:反感 += 接吻マーク反感
		ENDIF
	ENDIF
;沒穿と露出が増加
	SIF !EQUIP:LOCAL:下半身内衣１ && !EQUIP:LOCAL:下半身内衣２ && !TALENT:LOCAL:淫乱
		SOURCE:LOCAL:露出 += TIME_PROGRESS(TIME:1)

	SIF IsInsenceValid(LOCAL) || IsGardenValid(LOCAL)
		SOURCE:LOCAL:欲情 += TIME_PROGRESS(TIME:1) * (RAND:((ABL:LOCAL:欲望) + 1) + 3)

	SIF TEQUIP:LOCAL:吸乳头
		CALL EQUIP_COM11(LOCAL)
	SIF TEQUIP:LOCAL:揉胸
		CALL EQUIP_COM12(LOCAL)
	SIF TEQUIP:LOCAL:継続接吻
		CALL EQUIP_COM19(LOCAL)
	;装着系は後で考える
	SIF LOCAL > 0 && !CFLAG:LOCAL:同室
		CONTINUE
	;-------------------------------------------------
	;主人、同性、調教者の能力の処理
	;-------------------------------------------------
	CALL SOURCE_SEX_CHECK(LOCAL)
	CALL PLAYER_SKILL_CHECK(LOCAL)

	;-------------------------------------------------
	;技巧、好感度、情緒、理性のチェック
	;-------------------------------------------------
	FOR LOCAL:1,0,100
		SOURCE:LOCAL:(LOCAL:1) = SOURCE:LOCAL:(LOCAL:1) *  MASTER_FAVOR_CHECK(LOCAL,LOCAL:1) * TECHNIQUE_CHECK(LOCAL,LOCAL:1) / 10000
		SOURCE:LOCAL:(LOCAL:1) = SOURCE:LOCAL:(LOCAL:1) *  MOOD_CHECK(LOCAL,LOCAL:1) * REASON_CHECK(LOCAL,LOCAL:1) / 10000
	NEXT

	;-------------------------------------------------
	;中毒充足のチェック
	;-------------------------------------------------
	;自慰中毒
	IF EXP_UP(22,LOCAL)
		FOR LOCAL:1,0,100
			;快感,性行動,欲情,恭順,露出,屈従
			SIF (LOCAL:1 >= 0 && LOCAL:1 <= 9) || LOCAL:1 == 11 || (LOCAL:1 >= 15 && LOCAL:1 <= 18) 
				SOURCE:LOCAL:(LOCAL:1) = SOURCE:LOCAL:(LOCAL:1) * (100 + GET_REVISION(ABL:LOCAL:自慰中毒, 500, 15)) / 100
		NEXT
	ENDIF
	;-------------------------------------------------
	;振動棒など付けっぱ無道具のチェック
	;-------------------------------------------------
	CALL EQUIP_CHECK(LOCAL)
	;-------------------------------------------------
	;経験加算
	;-------------------------------------------------
	CALL SOURCE_EXP(LOCAL)
	;-------------------------------------------------
	;処女,童貞喪失の処理
	;-------------------------------------------------
	CALL LOST_VIRGIN(LOCAL)
	CALL 童貞無接吻経験喪失(LOCAL)
	;-------------------------------------------------
	;快Ｃのソース
	;-------------------------------------------------
	CALL SOURCE_快Ｃ(LOCAL)
	;-------------------------------------------------
	;快Ｖのソース
	;-------------------------------------------------
	CALL SOURCE_快Ｖ(LOCAL)
	;-------------------------------------------------
	;快Ａのソース
	;-------------------------------------------------
	CALL SOURCE_快Ａ(LOCAL)
	;-------------------------------------------------
	;快Ｂのソース
	;-------------------------------------------------
	CALL SOURCE_快Ｂ(LOCAL)
	;-------------------------------------------------
	;-------------------------------------------------
	;快Ｍのソース
	;-------------------------------------------------
	CALL SOURCE_快Ｍ(LOCAL)
	;-------------------------------------------------
	;与快Ｃのソース
	;-------------------------------------------------
	SIF !(TALENT:PLAYER:2 & 2)
	CALL SOURCE_与快Ｃ(LOCAL)
	;-------------------------------------------------
	;与快Ｖのソース
	;-------------------------------------------------
	CALL SOURCE_与快Ｖ(LOCAL)
	;-------------------------------------------------
	;与快Ａのソース
	;-------------------------------------------------
	CALL SOURCE_与快Ａ(LOCAL)
	;-------------------------------------------------
	;与快Ｂのソース
	;-------------------------------------------------
	CALL SOURCE_与快Ｂ(LOCAL)
	;-------------------------------------------------
	;与快Ｍのソース
	;-------------------------------------------------
	CALL SOURCE_与快Ｍ(LOCAL)
	;-------------------------------------------------
NEXT

;-------------------------------------------------
;同じ指令の連続実行による上下の処理（快楽系）
;-------------------------------------------------
IF SELECTCOM == PREVCOM && TFLAG:50 == TFLAG:151 && (SELECTCOM < 350 || SELECTCOM >= 500) && 連続実行()
	;UP:0,1,2,3は絶頂に絡むので先に処理してある
	CUP:TARGET:快Ｃ /= 2
	CUP:TARGET:快Ｖ /= 2
	CUP:TARGET:快Ａ /= 2
	CUP:TARGET:快Ｂ /= 2
	CUP:TARGET:快Ｍ /= 2
ENDIF
IF TCVAR:TARGET:强行
	TIMES CUP:TARGET:快Ｃ, 0.75
	TIMES CUP:TARGET:快Ｖ, 0.75
	TIMES CUP:TARGET:快Ａ, 0.75
	TIMES CUP:TARGET:快Ｂ, 0.75
	TIMES CUP:TARGET:快Ｍ, 0.75
ENDIF
IF TEQUIP:TARGET:挑逗モード
	TIMES CUP:TARGET:快Ｃ, 0.90
	TIMES CUP:TARGET:快Ｖ, 0.90
	TIMES CUP:TARGET:快Ａ, 0.90
	TIMES CUP:TARGET:快Ｂ, 0.90
	TIMES CUP:TARGET:快Ｍ, 0.90
ENDIF
IF TCVAR:TARGET:烂醉
	TIMES CUP:TARGET:快Ｃ, 0.70
	TIMES CUP:TARGET:快Ｖ, 0.70
	TIMES CUP:TARGET:快Ａ, 0.70
	TIMES CUP:TARGET:快Ｂ, 0.70
	TIMES CUP:TARGET:快Ｍ, 0.70
ENDIF

FOR LOCAL,0,CHARANUM
	;装着系は後で考える
	SIF LOCAL > 0 && !CFLAG:LOCAL:同室
		CONTINUE
	;其他系ソース計算処理
	CALL SOURCE_CVAB_EXTRA(LOCAL)
	
	BASE:LOCAL:勃起 = BASE:LOCAL:勃起 + CUP:LOCAL:快Ｃ / 5 + CUP:LOCAL:快Ｖ / 10 + CUP:LOCAL:快Ａ / 10 + CUP:LOCAL:快Ｂ / 10
	;-------------------------------------------------
	;絶頂処理
	;-------------------------------------------------
	CALL ORGASM_ADD(LOCAL)
NEXT

;-------------------------------------------------
;射精チェック（扶她・男人）
;-------------------------------------------------
;要検討
CALL EVENT_SHOOT

FOR LOCAL,0,CHARANUM
	SIF CFLAG:LOCAL:現在位置 == SUKIMA()
		CONTINUE
	;装着系は後で考える
	IF LOCAL > 0 && !CFLAG:LOCAL:同室
		SIF IsGardenValid(LOCAL)
			CALL SOURCE_欲情(LOCAL)
		CONTINUE
	ENDIF
	;-------------------------------------------------
	;調教対象の噴乳チェック
	;-------------------------------------------------
	CALL TARGET_MILK_CHECK(LOCAL)
	;-------------------------------------------------
	;睡姦からの復帰前処理
	;-------------------------------------------------
	CALL DRUNK_RECOVER_BEFORE(TARGET)
	;-------------------------------------------------
	;情愛のソース
	;-------------------------------------------------
	CALL SOURCE_情愛(LOCAL)
	;-------------------------------------------------
	;性行動のソース
	;-------------------------------------------------
	CALL SOURCE_性行動(LOCAL)
	;-------------------------------------------------
	;達成のソース
	;-------------------------------------------------
	CALL SOURCE_達成(LOCAL)
	;-------------------------------------------------
	;痛みのソース
	;-------------------------------------------------
	CALL SOURCE_苦痛(LOCAL)
	;-------------------------------------------------
	;恐れのソース
	;-------------------------------------------------
	CALL SOURCE_恐怖(LOCAL)
	;-------------------------------------------------
	;液体のソース
	;-------------------------------------------------
	CALL SOURCE_液体(LOCAL)
	;-------------------------------------------------
	;欲情のソース
	;-------------------------------------------------
	CALL SOURCE_欲情(LOCAL)
	;-------------------------------------------------
	;恭順のソース
	;-------------------------------------------------
	CALL SOURCE_恭順(LOCAL)
	;-------------------------------------------------
	;露出のソース
	;-------------------------------------------------
	CALL SOURCE_露出(LOCAL)
	;-------------------------------------------------
	;屈従のソース
	;-------------------------------------------------
	CALL SOURCE_屈従(LOCAL)
	
	;-------------------------------------------------
	;歓楽のソース
	;-------------------------------------------------
	CALL SOURCE_歓楽(LOCAL)
	;-------------------------------------------------
	;征服のソース
	;-------------------------------------------------
	CALL SOURCE_征服(LOCAL)
	;-------------------------------------------------
	;受動のソース
	;-------------------------------------------------
	CALL SOURCE_受動(LOCAL)
	;-------------------------------------------------
	;誘惑のソース
	;-------------------------------------------------
	CALL SOURCE_誘惑(LOCAL)
	;-------------------------------------------------
	;侮辱のソース
	;-------------------------------------------------
	CALL SOURCE_侮辱(LOCAL)
	;-------------------------------------------------
	;挑発のソース
	;-------------------------------------------------
	CALL SOURCE_挑発(LOCAL)
	;-------------------------------------------------
	;奉仕のソース
	;-------------------------------------------------
	CALL SOURCE_奉仕(LOCAL)
	;-------------------------------------------------
	;強要のソース
	;-------------------------------------------------
	CALL SOURCE_強要(LOCAL)
	;-------------------------------------------------
	;加虐のソース
	;-------------------------------------------------
	CALL SOURCE_加虐(LOCAL)
	
	;-------------------------------------------------
	;不潔のソース
	;-------------------------------------------------
	CALL SOURCE_不潔(LOCAL)
	;-------------------------------------------------
	;鬱屈のソース
	;-------------------------------------------------
	CALL SOURCE_鬱屈(LOCAL)
	;-------------------------------------------------
	;逸脱のソース
	;-------------------------------------------------
	CALL SOURCE_逸脱(LOCAL)
	;-------------------------------------------------
	;反感のソース
	;-------------------------------------------------
	CALL SOURCE_反感(LOCAL)
	;-------------------------------------------------
	;素質などによる上下の処理
	;-------------------------------------------------
	CALL SOURCE_EXTRA(LOCAL)
	;-------------------------------------------------
	;睡眠深度の減少処理
	;-------------------------------------------------
	CALL 睡眠深度減少(LOCAL)

	;魔改五重绝顶魔法，魔力印记现在防止过度增加不快，以免EX模式出现反発，防止过度痛苦直接体力见底。
	IF SOURCE:TARGET:魔力印记 == 1
		CUP:LOCAL:欲情 /= FLAG:魔法强度
		CUP:LOCAL:不快 /= FLAG:魔法强度
		DOWNBASE:LOCAL:体力 /= FLAG:魔法强度
		DOWNBASE:LOCAL:気力 /= FLAG:魔法强度
	ENDIF
NEXT
;-------------------------------------------------
;同じ指令の連続実行による上下の処理
;-------------------------------------------------
IF SELECTCOM == PREVCOM && TFLAG:50 == TFLAG:151 && (SELECTCOM < 350 || SELECTCOM >= 500) && 連続実行()
	;UP:0,1,2は絶頂に絡むので先に処理してある
	UP:欲情 /= 2
	UP:恭順 /= 2
	UP:屈服 /= 2
	UP:習得 /= 2
	UP:恥情 /= 2
	UP:恐怖 /= 2
	UP:苦痛 /= 2
	UP:好意 /= 2
	UP:優越 /= 2
ENDIF

LOCAL:1 = 0
FOR LOCAL,0,CHARANUM
	SIF CFLAG:LOCAL:現在位置 == SUKIMA()
		CONTINUE
	LOCAL:1 += CUP:LOCAL:欲情 / 5
	LOCAL:1 += MAX(5,(ABL:LOCAL:受虐属性 - 3)) * (CUP:LOCAL:苦痛 + CUP:LOCAL:苦痛) / 2
	LOCAL:1 += MAX(5,(ABL:LOCAL:受虐属性 - 1)) * CUP:LOCAL:恥情 / 2
	LOCAL:1 = MIN(500,LOCAL:1)
	BASE:LOCAL:勃起 = BASE:LOCAL:勃起 + LOCAL:1
	;装着系は後で考える
	SIF LOCAL > 0 && !CFLAG:LOCAL:同室
		CONTINUE
	;-------------------------------------------------
	;体力・気力の減少
	;-------------------------------------------------
	IF WEATHERDLC
		IF TIME:5 == 7
			IF LOCAL != 0 && TFLAG:50 == TFLAG:151 && (SELECTCOM < 350 || SELECTCOM >= 500)
				DOWNBASE:LOCAL:気力 -= DOWNBASE:LOCAL:気力 * 2
				DOWNBASE:LOCAL:体力 -= DOWNBASE:LOCAL:体力 * 2
			ENDIF
		ELSEIF TIME:5 == 9
			DOWNBASE:LOCAL:体力 = ( DOWNBASE:LOCAL:体力 * 3 ) / 2
		ELSEIF TIME:5 == 14
			DOWNBASE:LOCAL:体力 = DOWNBASE:LOCAL:体力 / 2
		ENDIF
	ENDIF

	CALL SOURCE_DOWNBASE(LOCAL)
	;-------------------------------------------------
	;苦痛快楽経験、奉仕快楽経験のチェック
	;-------------------------------------------------
	CALL EXP_GOT_CHECK(LOCAL)
NEXT

$SOURCE_SKIP

@KASEN_OFTE(ARG)
IF CFLAG:ARG:口上セレクタ
	TRYCALLFORM M_KOJO_K{ARG}_{CFLAG:ARG:口上セレクタ}
ELSE
	TRYCALLFORM M_KOJO_K{ARG}
ENDIF
TRYCCALLFORM M_KOJO%RESULTS%_COLOR_K{ARG}
CATCH
RESETCOLOR
ENDCATCH
GETCOLOR
RETURN  RESULT

@KASEN_OFTE_SET(ARG)
CALL KASEN_OFTE(ARG)
SETCOLOR RESULT
