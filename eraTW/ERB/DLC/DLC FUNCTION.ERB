@WEATHERDLC_EV15()
#FUNCTIONS
FLAG:異常気象 = 6 + RAND:9

	WHILE FLAG:異常気象 == 9 || FLAG:異常気象 == 10
		FLAG:異常気象 = 6 + RAND:9
	WEND
	TIME:5 = 0

	SELECTCASE FLAG:異常気象
		CASE 6
			RETURNF "変得喜歡真空出門"
		CASE 7
			RETURNF "内裤被风吹的到处跑"
		CASE 8
			RETURNF "桃色之風吹起来了"
		CASE 11
			RETURNF "亮晶晶的钻石尘在空中闪耀着"
		CASE 12
			RETURNF "沙尘暴吹起来了"
		CASE 13
			RETURNF "阳光变得比平时要刺眼"
		CASE 14
			RETURNF "极光在高空闪耀着"
	ENDSELECT

@EXTRA_HANDBOOK
#DIM 收藏隙間入手数
#DIM 易書入手数

IF HANDBOOK
	IF FLAG:收藏隙間 < NOW_PERIOD()
		收藏隙間入手数 = 200
		易書入手数 = 20
	ELSE
		收藏隙間入手数 = (FLAG:收藏隙間 - NOW_PERIOD()) * 2
		易書入手数 = FLAG:收藏隙間 - NOW_PERIOD()
	ENDIF
	ITEM:收藏隙間 = MIN(收藏隙間入手数 + ITEM:收藏隙間, 1500)
	ITEM:易書 = MIN(易書入手数 + ITEM:易書, 500)
ELSE
	IF FLAG:收藏隙間 < NOW_PERIOD()
		收藏隙間入手数 = 200
		易書入手数 = 20
	ELSE
		收藏隙間入手数 = (FLAG:收藏隙間 - NOW_PERIOD()) * 2
		易書入手数 = FLAG:收藏隙間 - NOW_PERIOD()
	ENDIF
	ITEM:收藏隙間 = MIN(收藏隙間入手数 + ITEM:收藏隙間, 1500)
	ITEM:易書 = MIN(易書入手数 + ITEM:易書, 500)
ENDIF

@SP_ENCOUNT
IF SUMIPROTECT
	IF MONEY:2 < 10
		PRINTFORML 因為籌碼不足、所以超能力的加护被中止了
		SUMIPROTECT = 0
	ELSE
		PRINTFORML 要繼續请求堇子的加护麼？
		CALL ASK_YN
		IF !RESULT
			PRINTFORML 更新了契約
			MONEY:2 -= 10
		ELSE
			SUMIPROTECT = 0
			PRINTFORML 堇子收回了加护魔法
		ENDIF
	ENDIF
ENDIF

@SP_WEATHERCHANGE()
#FUNCTION

	SELECTCASE TIME:5
		CASE 0
			IF DAY:2 == 2
				LOCAL = 3
			ELSEIF DAY:2 == 4
				LOCAL = 3
			ELSE
				LOCAL = 5
			ENDIF
		CASE 1
			IF DAY:2 == 2
				LOCAL = 3
			ELSEIF DAY:2 == 4
				LOCAL = 3
			ELSE
				LOCAL = 5
			ENDIF
		CASE 2
			IF DAY:2 == 2
				LOCAL = 4
			ELSEIF DAY:2 == 4
				LOCAL = 4
			ELSE
				LOCAL = 5
			ENDIF
		CASE 3
			IF DAY:2 == 2
				LOCAL = 1
			ELSEIF DAY:2 == 4
				LOCAL = 3
			ELSE
				LOCAL = 4
			ENDIF
		CASE 4
			IF DAY:2 == 4
				LOCAL = 4
			ELSEIF DAY:2 == 2
				LOCAL = 8
			ELSE
				LOCAL = 2
			ENDIF
		CASE 5
			IF DAY:2 == 4
				LOCAL = 1
			ELSEIF DAY:2 == 2
				LOCAL = 6
			ELSE
				LOCAL = 1
			ENDIF
		CASE 6
			IF DAY:2 == 4
				LOCAL = 1
			ELSEIF DAY:2 == 2
				LOCAL = 6
			ELSE
				LOCAL = 4
			ENDIF
		CASE 7
			IF DAY:2 == 2
				LOCAL = 1
			ELSEIF DAY:2 == 4
				LOCAL = 3
			ELSE
				LOCAL = 2
			ENDIF
		CASE 8
			IF DAY:2 == 2
				LOCAL = 1
			ELSEIF DAY:2 == 4
				LOCAL = 8
			ELSE
				LOCAL = 2
			ENDIF
		CASE 9
			IF DAY:2 == 2
				LOCAL = 1
			ELSEIF DAY:2 == 4
				LOCAL = 6
			ELSE
				LOCAL = 1
			ENDIF
		CASE 10
			IF DAY:2 == 2
				LOCAL = 1
			ELSEIF DAY:2 == 4
				LOCAL = 8
			ELSE
				LOCAL = 2
			ENDIF
		CASE 11
			IF DAY:2 == 2
				LOCAL = 1
			ELSEIF DAY:2 == 4
				LOCAL = 3
			ELSE
				LOCAL = 2
			ENDIF
		CASE 12
			IF DAY:2 == 2
				LOCAL = 1
			ELSEIF DAY:2 == 4
				LOCAL = 5
			ELSE
				LOCAL = 2
			ENDIF
		CASE 13
			IF DAY:2 == 2
				LOCAL = 2
			ELSEIF DAY:2 == 4
				LOCAL = 1
			ELSE
				LOCAL = 1
			ENDIF
		CASE 14
			IF DAY:2 == 2
				LOCAL = 2
			ELSEIF DAY:2 == 4
				LOCAL = 1
			ELSE
				LOCAL = 2
			ENDIF
		CASE 15
			IF DAY:2 == 2
				LOCAL = 2
			ELSEIF DAY:2 == 4
				LOCAL = 1
			ELSE
				LOCAL = 4
			ENDIF
		CASE 16
			IF DAY:2 == 2
				LOCAL = 3
			ELSEIF DAY:2 == 4
				LOCAL = 2
			ELSE
				LOCAL = 3
			ENDIF
		CASE 17
			IF DAY:2 == 2
				LOCAL = 2
			ELSEIF DAY:2 == 4
				LOCAL = 2
			ELSE
				LOCAL = 4
			ENDIF
		CASE 18
			IF DAY:2 == 2
				LOCAL = 2
			ELSEIF DAY:2 == 4
				LOCAL = 2
			ELSEIF DAY:2 == 3
				LOCAL = 3
			ELSE
				LOCAL = 6
			ENDIF
		CASE 19
			IF DAY:2 == 2
				LOCAL = 4
			ELSEIF DAY:2 == 4
				LOCAL = 3
			ELSE
				LOCAL = 1
			ENDIF
		CASE 20
			IF DAY:2 == 2
				LOCAL = 2
			ELSEIF DAY:2 == 4
				LOCAL = 2
			ELSEIF DAY:2 == 3
				LOCAL = 5
			ELSE
				LOCAL = 3
		ENDIF
		CASEELSE
			LOCAL = 1
	ENDSELECT

RETURNF LOCAL

@SP_WEATHERCHANGED()
#DIM 地底
地底 = 0
IF CFLAG:MASTER:约会中 == 9
	地底 = 1
ELSEIF CFLAG:MASTER:現在位置 == OMANEKIBEYA() && GROUPMATCH(CFLAG:MASTER:招待, 36, 37, 38, 49, 60, 64, 83, 84)
	地底 = 1
ENDIF
SELECTCASE TIME:5
;晴れの時
CASE 0,1,19
	FOR LOCAL, 0, CHARANUM
		IF MAXBASE:LOCAL:気力 <= 1500
	 		MAXBASE:LOCAL:気力 = 1500
	 		BASE:LOCAL:気力 = MAXBASE:LOCAL:気力
		ENDIF
	NEXT
	;20%继续是晴天
	IF RAND:5 == 0
		IF TIME:5 == 1
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 天空上一丝云彩都找不到
		ENDIF
		TIME:5 = 0
	;20%晴朗
	ELSEIF RAND:4 == 0
		IF TIME:5 == 0
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 天空上漂浮着几缕云彩
		ENDIF
		TIME:5 = 1
	;20%几率多云
	ELSEIF RAND:3 == 0
		TIME:5 = 2
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 变成了多云天气了
	;10%几率阴天
	ELSEIF RAND:4 == 0
		TIME:5 = 3
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 浓浓的云彩遮盖了天空
	;10%几率晴岚
	ELSEIF RAND:3 == 0 && TIME:2 >= 6 && TIME:2 <= 1
		TIME:5 = 17
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 升腾起了淡淡的烟雾
	;10%几率无风
	ELSEIF TIME:5 != 19 && RAND:2 == 0
		TIME:5 = 19
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 一丝风都没有
	;4%几率太阳雨
	ELSEIF RAND:25 == 0	
		TIME:5 = 14
	SIF !CFLAG:MASTER:诶嘿嘿 && !地底
		PRINTW 下起了暴雨！
	;夏天6%几率冰雹
	ELSEIF DAY:2 == 2
		IF RAND:1 == 0
	 		TIME:5 = 13
	 		FOR LOCAL, 0, CHARANUM
	 		 	MAXBASE:LOCAL:気力 += 300
	 		NEXT
		ENDIF
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 突然下起了冰雹！
	;其他季节2%几率冰雹
	ELSEIF RAND:3 == 0
		TIME:5 = 13
		FOR LOCAL, 0, CHARANUM
	 		MAXBASE:LOCAL:気力 += 300
		NEXT
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 突然下起了冰雹！
	;上記確率に引っかからなかったら晴れ
	ENDIF
;曇りの時
CASE 2,3
	;20%几率变晴
	IF RAND:5 == 0
		IF TIME:5 == 2
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 天空上漂浮着几缕云彩
	 		TIME:5 = 1
		ELSE
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 变成了多云天气了
	 		TIME:5 = 2
		ENDIF
	;20%几率不变
	ELSEIF RAND:4 == 0
		TIME:5 = TIME:5
	;10%几率加重
	ELSEIF RAND:6
		IF TIME:5 == 2	
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 浓浓的云彩遮盖了天空
		ENDIF
		TIME:5  = 3
	;10%几率晴天
	ELSEIF RAND:5 == 0
		TIME:5 = 0
		IF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		IF TIME:2 >= 5 && TIME:2 <= 7
	 		 	PRINTW 可以看见星星了
	 		ELSE
	 		 	PRINTW 太阳出来了
	 		ENDIF
		ENDIF
	;薄曇なら10%で雨か雪に移行
	ELSEIF TIME:5 == 2
		IF RAND:4 == 0
	 		IF DAY:2 == 4
	 		 	TIME:5 = 8
	 		 	SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 		PRINTW 下雪了！
	 		ELSEIF DAY:2 == 3
	 		 	IF RAND:2 == 0
	 		 		TIME:5 = 20
	 		 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 PRINTW 稀稀拉拉的下起了梅雨
	 		 	ENDIF
	 		ELSE
	 		 	TIME:5 = 4
	 		 	SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 		PRINTW 下雨了！
	 		ENDIF
		ENDIF
		IF RAND:2 == 0 && TIME:2 >= 6 && TIME:2 <= 1
	 		IF RAND:2 == 0
	 		 	TIME:5 = 7
	 		ELSE
	 		 	TIME:5 = 18
	 		ENDIF
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 起雾了
		ENDIF
	ELSEIF TIME:5 == 3 && RAND:4 == 0
		IF DAY:2 == 2
	 		TIME:5 = 16
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 雨伴随着风落到了地面上
		ENDIF
	;曇りなら30%で雨に移行
	ELSEIF TIME:5 == 3 && RAND:1 == 0
		IF DAY:2 == 4
	 		TIME:5 = 8
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 下雪了！
		ELSE
	 		TIME:5 = 4
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 下雨了！
		ENDIF
	ENDIF
;雨の時
CASE 4,5,6,14,15,16,20
	;25%变成大雨
	IF RAND:4 == 0
		IF TIME:5 != 5 && TIME:5 != 14
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 大雨倾盆落下！！！
	 		TIME:5 = 5
		ENDIF
	;25%阴天
	ELSEIF RAND:3 == 0
		TIME:5 = 3
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 雨要停了的様子
		;念のため相合い傘を解除
		FOR LOCAL,0,CHARANUM
	 		SIF TEQUIP:LOCAL:201
	 		 	TEQUIP:LOCAL:201 = 0
		NEXT
	;雨なら10%で霧雨かみぞれに移行
	ELSEIF TIME:5 == 4 && RAND:5 == 0
		IF DAY:2 == 4
	 		TIME:5 = 12
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 雨中掺了一些雪花
		ELSE
	 		TIME:5 = 6
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 雨点变小了
	 		ENDIF
	;10%で晴れに移行
	ELSEIF RAND:4 == 0
		TIME:5 = 0
		IF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		;かもしれないといいつつ確実に見えるのは気分をよくさせる魔法
	 		IF TIME:2 >= 5 && TIME:2 <= 7
	 		 	PRINTW 突然星空变的晴朗了！说不定能看到月下彩虹呢
	 		ELSE
	 		 	PRINTW 突然太阳出来了！说不定能看到彩虹呢
	 		ENDIF
	 		FOR LOCAL,0,CHARANUM
	 		 	SIF TEQUIP:LOCAL:201
	 		 		TEQUIP:LOCAL:201 = 0
	 		NEXT
		ENDIF
		;更に低確率で快晴
		SIF RAND:5 < 1
	 		TIME:5 = 1
		;雨→晴れを処理したら虹が出る
		TIME:7 = 1
	ENDIF
CASE 7,17,18
	IF TIME:2 > 1 || TIME:2 < 6
		TIME:5 = 0
		IF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 雾散去了
		ENDIF
	ELSEIF RAND:4 == 0
		TIME:5 = 0
		IF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		IF TIME:2 >= 5 && TIME:2 <= 7
	 		 	PRINTW 可以看见星星了
	 		ELSE
	 		 	PRINTW 太阳出来了
	 		ENDIF
		ENDIF
	ELSEIF RAND:3 == 0
		TIME:5 = 1
		IF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 雾渐渐的散了
		ENDIF
	ENDIF
;雪の時
CASE 8
	;雪は冬以外降らない
	IF DAY:2 != 4
		;雨になる
		TIME:5 = 4
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 雪天好像变成了雨天的様子
	;10%で強化
	ELSEIF RAND:10 == 0
		TIME:5 = 9
		PRINTW 雪花变得更加密集了！！！
	;30%の確率で弱体化
	ELSEIF RAND:3 == 0
		IF RAND:2 == 0
	 		TIME:5 = 10
		ELSE
	 		TIME:5 = 11
		ENDIF
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 降雪好像变弱了
	ELSEIF RAND:2 == 0
	 		TIME:5 = 3
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 雪好像停了的様子
	 		FOR LOCAL,0,CHARANUM
	 		 	SIF TEQUIP:LOCAL:201
	 		 		TEQUIP:LOCAL:201 = 0
	 		NEXT
	;雪なら10%で細雪かみぞれに移行
	ELSEIF RAND:3 == 0
	 		TIME:5 = 12
	 		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		 	PRINTW 雪中掺了一些雨点
	;10%で晴れに移行
	ELSEIF RAND:2 == 0
		TIME:5 = 0
		IF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		IF TIME:2 >= 5 && TIME:2 <= 7
	 		 	PRINTW 突然星空变的晴朗了！说不定能看到钻石尘呢
	 		ELSE
	 		 	PRINTW 突然太阳出来了！说不定能看到钻石尘呢
	 		ENDIF
	 		FOR LOCAL,0,CHARANUM
	 		 	SIF TEQUIP:LOCAL:201
	 		 		TEQUIP:LOCAL:201 = 0
	 		NEXT
		ENDIF
		;更に低確率で快晴
		SIF RAND:5 < 1
	 		TIME:5 = 1
		TIME:7 = 2
	ENDIF
CASE 9,12
	;雪は冬以外降らない
	IF DAY:2 != 4
		;雨になる
		TIME:5 = 4
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 雪天好像变成了雨天的様子
	ELSEIF RAND:5 == 0
		TIME:5 = 8
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 雪变小了
	ELSEIF RAND:4 == 0
		TIME:5 = 0
		IF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		IF TIME:2 >= 5 && TIME:2 <= 7
	 		 	PRINTW 突然星空变的晴朗了！说不定能看到钻石尘呢
	 		ELSE
	 		 	PRINTW 突然太阳出来了！说不定能看到钻石尘呢
	 		ENDIF
	 		FOR LOCAL,0,CHARANUM
	 		 	SIF TEQUIP:LOCAL:201
	 		 		TEQUIP:LOCAL:201 = 0
	 		NEXT
		ENDIF
		;更に低確率で快晴
		SIF RAND:5 < 1
	 		TIME:5 = 1
		TIME:7 = 2
	ENDIF
CASE 10,11
	;雪は冬以外降らない
	IF DAY:2 != 4
		;雨になる
		TIME:5 = 3
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 雪天好像变成了雨天的様子
	ELSEIF RAND:2 == 0
		TIME:5 = 8
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 雪变小了
	ELSEIF RAND:5 == 0
		TIME:5 = 0
		IF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		IF TIME:2 >= 5 && TIME:2 <= 7
	 		 	PRINTW 突然星空变的晴朗了！说不定能看到钻石尘呢
	 		ELSE
	 		 	PRINTW 突然太阳出来了！说不定能看到钻石尘呢
	 		ENDIF
	 		FOR LOCAL,0,CHARANUM
	 		 	SIF TEQUIP:LOCAL:201
	 		 		TEQUIP:LOCAL:201 = 0
	 		NEXT
		ENDIF
		;更に低確率で快晴
		SIF RAND:5 < 1
	 		TIME:5 = 1
		TIME:7 = 2
	ENDIF
CASE 13
	IF RAND:5 < 4	
		FOR LOCAL, 0, CHARANUM
	 		MAXBASE:LOCAL:気力 -= 300
	 		IF BASE:LOCAL:気力 >= MAXBASE:LOCAL:気力
	 		 	BASE:LOCAL:気力 = MAXBASE:LOCAL:気力
	 		ENDIF
		NEXT
		TIME:5 = 0
		SIF !CFLAG:MASTER:诶嘿嘿 && !地底
	 		PRINTW 冰雹消失了
	ENDIF
CASEELSE
	TIME:5 = RAND:5
ENDSELECT