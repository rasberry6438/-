;-------------------------------------------------
;カウンター初期設定
;恍惚確率			TFLAG:恍惚確率
;弱点効果			TFLAG:恍惚確率の弱点補正
;推倒確率		TFLAG:推倒確率
;反撃せず			CFLAG:マグロ
;-------------------------------------------------
@SET_COUNTER_BASE
#DIM LCOUNT

;MASTER以外の精力限界値セット
FOR LCOUNT, 2, CHARANUM
	MAXBASE:LCOUNT:精力 = 3 + MAXBASE:LCOUNT:体力/300 + TALENT:LCOUNT:性豪*20

	SELECTCASE ABL:LCOUNT:欲望
	CASE IS <= 10
		MAXBASE:LCOUNT:精力 += ABL:LCOUNT:欲望*3
	CASEELSE
		MAXBASE:LCOUNT:精力 += 30 + (ABL:LCOUNT:欲望 - 10)
	ENDSELECT

	SIF TALENT:LCOUNT:淫乱
		MAXBASE:LCOUNT:精力 += 10
	SIF MARK:LCOUNT:淫紋 >= 2
		MAXBASE:LCOUNT:精力 += (MARK:LCOUNT:淫紋 - 1)*5
NEXT

;MASTERの精力限界値重置(最初期は25)
MAXBASE:MASTER:精力 = 10 + TALENT:MASTER:性豪*20 + TALENT:MASTER:復活*15/100

;精力が0 or上限を越えている場合の処理
FOR LCOUNT, 1, CHARANUM
	SIF BASE:LCOUNT:精力 == 0 || BASE:LCOUNT:精力 > MAXBASE:LCOUNT:精力
		BASE:LCOUNT:精力 = MAXBASE:LCOUNT:精力
NEXT

;你以外の魂は、集めた量なのでここでは設定しない
MAXBASE:MASTER:魂 = 100 + TALENT:MASTER:復活

;設定直後は０なのでMAXBASEに合わせる
SIF BASE:MASTER:魂 == 0
	BASE:MASTER:魂 = MAXBASE:MASTER:魂


@SET_COUNTER_ABL
#DIM LCOUNT
;ジャンルごとに何をやるかとその確率を決定
CALL CALC_COUNTER_ABL, TARGET

;同じ指令を連続で行う確率は低くする
FOR LCOUNT, 0, 11
	SIF ABL:(LCOUNT + 70) && I:LCOUNT == PREVCOM
		ABL:(LCOUNT + 70) = MAX(ABL:(LCOUNT + 70)/2, 1)
NEXT
;-------------------------------------------------
;挿入している時の口交など、不可能な行動はここで処理
;-------------------------------------------------
;挿入でイかされた後は、ご奉仕か接吻率が高い
IF ( (INSERT("Ｖ挿入") || PREVCOM == 65 || PREVCOM == 66 || PREVCOM == 67) && PREVEX("Ｖ絶頂") ) || ( (INSERT("Ａ挿入") || PREVCOM == 75) && PREVEX("Ａ絶頂") ) || ( (INSERT("尿道挿入") || PREVCOM == 88) && PREVEX("尿道絶頂") )
	ABL:手 /= 4
	ABL:口 *= 4
	SIF I:2 != 104
		ABL:胸 /= 4
	ABL:足 /= 4
	;施虐属性あるならお掃除強要
	IF ABL:欲望 + ABL:施虐属性 >= ABL:奉仕精神 * 2 && RAND:2 == 0
		ABL:面部騎乗 *= 3
	ELSE
		ABL:面部騎乗 /= 5
	ENDIF
	ABL:接吻 *= 2
	ABL:玩弄臀部 /= 5
	ABL:强奸 /= 5
	ABL:素股 /= 4
	ABL:道具 = 0
;挿入の後は挿入or挿入れたままできること
ELSEIF INSERT("挿入") && ABL:騎乗位 + ABL:接吻 && RAND:4
	ABL:手 = 0
	ABL:口 = 0
	SIF I:2 != 104
		ABL:胸 = 0
	ABL:足 = 0
	ABL:面部騎乗 = 0
	ABL:玩弄臀部 = 0
	ABL:强奸 = 0
	ABL:素股 = 0
	ABL:道具 = 0
;强奸の後は連続强奸or使った穴に礼物
ELSEIF (PREVCOM == 120 || PREVCOM == 126) && ABL:强奸 && RAND:3
	ABL:手 = 0
	SIF TALENT:恋慕 == 0 && ABL:奉仕精神 < ABL:施虐属性
		ABL:口 = 0
	ABL:胸 = 0
	ABL:足 = 0
	ABL:面部騎乗 = 0
	ABL:騎乗位 = 0
	ABL:接吻 = 0
	SIF PREVCOM != 84 && ABL:奉仕精神 < ABL:施虐属性
		ABL:玩弄臀部 = 0
	ABL:素股 = 0
	ABL:道具 = 0
;阴茎に奉仕した後は奉仕or挿入率が高い
ELSEIF PENIS(PLAYER) && PREVCOM >= 90 && PREVCOM <= 119 && ABL:手 + ABL:口 + ABL:胸 + ABL:玩弄臀部 + ABL:素股 && RAND:4
	ABL:足 = 0
	ABL:騎乗位 *= 2
	ABL:接吻 = 0
	ABL:强奸 = 0
	ABL:道具 = 0
;潤滑が少ない時には、面部騎乗や口交率が高く、挿入率が低い
ELSEIF MAX(PALAM:Ｖ潤, PALAM:Ａ潤, PALAM:PLAYER:Ｐ潤) < 500 && ABL:面部騎乗
	SIF I:1 == 91
		ABL:口 *= 2
	ABL:面部騎乗 *= 2
	ABL:騎乗位 /= 5
	ABL:素股 /= 5
ENDIF

SELECTCOM = SET_COUNTERCOM(TARGET)

CALL SETFLAG, "狂野摇摆", TARGET

@SET_COUNTERCOM(ARG)
#FUNCTION
#DIM LCOUNT
;確率の母体決定
LOCAL = ABL:ARG:手+ABL:ARG:口+ABL:ARG:胸+ABL:ARG:足+ABL:ARG:面部騎乗+ABL:ARG:騎乗位+ABL:ARG:接吻+ABL:ARG:玩弄臀部+ABL:ARG:强奸+ABL:ARG:素股+ABL:ARG:道具
IF LOCAL == 0
	IF ARG == TARGET
		IF TALENT:男性
			ABL:面部騎乗 = 1
			RETURNF 9
		ELSE
			ABL:面部騎乗 = 1
			RETURNF 1
		ENDIF
	ELSE
		RETURNF -1
	ENDIF
ENDIF

;PRINTFORML 確率母体 = {LOCAL}
;FOR LCOUNT, 40, 51
;	PRINTFORML %TEXT_RJ(ABLNAME:LCOUNT, 10)%率 ≒ {ABL:ARG:LCOUNT*100/LOCAL}％
;NEXT

LOCAL = 1 + RAND:LOCAL
SELECTCASE LOCAL
;手
CASE IS <= ABL:ARG:手
	RETURNF I:0
;口
CASE IS <= ABL:ARG:手+ABL:ARG:口
	RETURNF I:1
;胸
CASE IS <= ABL:ARG:手+ABL:ARG:口+ABL:ARG:胸
	RETURNF I:2
;足
CASE IS <= ABL:ARG:手+ABL:ARG:口+ABL:ARG:胸+ABL:ARG:足
	RETURNF I:3
;面部騎乗
CASE IS <= ABL:ARG:手+ABL:ARG:口+ABL:ARG:胸+ABL:ARG:足+ABL:ARG:面部騎乗
	RETURNF I:4
;騎乗位
CASE IS <= ABL:ARG:手+ABL:ARG:口+ABL:ARG:胸+ABL:ARG:足+ABL:ARG:面部騎乗+ABL:ARG:騎乗位
	RETURNF I:5
;接吻
CASE IS <= ABL:ARG:手+ABL:ARG:口+ABL:ARG:胸+ABL:ARG:足+ABL:ARG:面部騎乗+ABL:ARG:騎乗位+ABL:ARG:接吻
	RETURNF I:6
;お尻
CASE IS <= ABL:ARG:手+ABL:ARG:口+ABL:ARG:胸+ABL:ARG:足+ABL:ARG:面部騎乗+ABL:ARG:騎乗位+ABL:ARG:接吻+ABL:ARG:玩弄臀部
	RETURNF I:7
;强奸
CASE IS <= ABL:ARG:手+ABL:ARG:口+ABL:ARG:胸+ABL:ARG:足+ABL:ARG:面部騎乗+ABL:ARG:騎乗位+ABL:ARG:接吻+ABL:ARG:玩弄臀部+ABL:ARG:强奸
	RETURNF I:8
;素股
CASE IS <= ABL:ARG:手+ABL:ARG:口+ABL:ARG:胸+ABL:ARG:足+ABL:ARG:面部騎乗+ABL:ARG:騎乗位+ABL:ARG:接吻+ABL:ARG:玩弄臀部+ABL:ARG:强奸+ABL:ARG:素股
	RETURNF I:9
CASEELSE
	RETURNF I:10
ENDSELECT


@CALC_COUNTER_ABL, ARG
#DIM LCOUNT
#DIM MEMO_TARGET
MEMO_TARGET = TARGET
TARGET = ARG

;奉仕系の種別では、対応する得意技能の意味が強め
VARSET I

SELECTCASE MIN(ABL:奉仕精神, 10)/2 - MIN(ABL:欲望, 10)/2 - TEQUIP:媚薬/100
CASE IS > 0
	LOCAL:1 = (MIN(ABL:奉仕精神, 10)/2 - MIN(ABL:欲望, 10)/2 - TEQUIP:媚薬/100)*2
CASE IS < 0
	LOCAL:2 = (TEQUIP:媚薬/100 + MIN(ABL:欲望, 10)/2 - MIN(ABL:奉仕精神, 10)/2)*2
ENDSELECT

;ABL:手,手
IF COND("調教側")
	CALL COUNTER_ABL, 0, 5, 7, 8, 141
ELSE
	CALL COUNTER_ABL, 0, 90, 97, 105
ENDIF
IF ABL:手
	ABL:手 += TALENT:献身 + LOCAL:1 + ABL:指靈活
	SIF COND("手弱点", PLAYER)
		ABL:手 += 5
ENDIF

;ABL:口,口
IF COND("調教側")
	CALL COUNTER_ABL, 1, 1
ELSE
	CALL COUNTER_ABL, 1, 91, 98, 150
ENDIF
IF ABL:口
	ABL:口 += TALENT:献身 + LOCAL:1 + ABL:舌靈活
	SIF COND("口弱点", PLAYER)
		ABL:口 += 5
ENDIF

;ABL:胸,胸
IF COND("調教側")
ELSE
	CALL COUNTER_ABL, 2, 82, 92, 104
ENDIF
IF ABL:胸
	ABL:胸 += TALENT:献身 + TALENT:巨乳*3 + LOCAL:1 + ABL:魔乳
	SIF COND("胸弱点", PLAYER)
		ABL:胸 += 5
ENDIF

;ABL:足,足
IF COND("調教側")
ELSE
	IF MAX(ABL:施虐属性, ABL:奉仕精神) + ABL:PLAYER:受虐属性 >= 2
		CALL COUNTER_ABL, 3, 95
	ELSE
		ABL:足 = 0
	ENDIF
ENDIF
IF ABL:足
	ABL:足 += TALENT:高慢 + LOCAL:1 + MIN(ABL:施虐属性, 5) + ABL:指靈活
	SIF COND("脚弱点", PLAYER)
		ABL:足 += 5
ENDIF

;ABL:面部騎乗,面部騎乗
IF COND("調教側")
	CALL COUNTER_ABL, 4, 98
ELSE
	;聖水イベントは前提条件が厳しくレアなので確率優遇
	CALL COM_ABLE144
	IF RESULT
		CALL COUNTER_ABL, 4, 144
	ELSEIF ABL:Ａ感覚 >= 3 || TALENT:男性
		CALL COUNTER_ABL, 4, 1, 9, 144
	ELSE
		CALL COUNTER_ABL, 4, 1, 144
	ENDIF
ENDIF
IF ABL:面部騎乗
	ABL:面部騎乗 += TALENT:好色 + TALENT:淫乱 + LOCAL:2 + ABL:腰靈活 + MIN(ABL:PLAYER:受虐属性, 5)/2
	SELECTCASE I:4
	CASE 1
		ABL:面部騎乗 += TALENT:淫壷
		SIF COND("♀弱点", PLAYER)
			ABL:面部騎乗 += 5
	CASE 9
		ABL:面部騎乗 += TALENT:尻穴狂い
		SIF COND("肛門弱点", PLAYER)
			ABL:面部騎乗 += 5
	CASE 144
		;比較的レアイベントなので確率高め
		ABL:面部騎乗 += ABL:施虐属性*10
		SIF TALENT:倒錯的
			ABL:面部騎乗 += 50
		SELECTCASE BASE:尿意
		CASE IS >= 20000
			ABL:面部騎乗 += 100
		CASE IS >= 15000
			ABL:面部騎乗 += 50
		ENDSELECT
	ENDSELECT
ENDIF

;ABL:騎乗位,騎乗位
IF COND("調教側")
ELSE
	;基本はＶ騎乗位だが、Ａと尿道でも出来るかで分岐
	IF CHECK("Ａ挿入") && CHECK("尿道挿入")
		;淫壷と尻穴狂いの有無で確率にすごい偏りが出る
		IF TALENT:淫壷 && TALENT:尻穴狂い == 0 && TALENT:尿道狂 == 0 && RAND:10
			CALL COUNTER_ABL, 5, 65, 66, 67, 68
		ELSEIF TALENT:淫壷 == 0 && TALENT:尻穴狂い && TALENT:尿道狂 == 0 && RAND:10
			CALL COUNTER_ABL, 5, 75
		ELSEIF TALENT:淫壷 == 0 && TALENT:尻穴狂い == 0 && TALENT:尿道狂 && RAND:10
			CALL COUNTER_ABL, 5, 88
		ELSE
			CALL COUNTER_ABL, 5, 65, 66, 67, 68, 75, 88
		ENDIF
	ELSEIF CHECK("尿道挿入")
		;淫壷と尿道狂の有無で確率にすごい偏りが出る
		IF TALENT:淫壷 && TALENT:尿道狂 == 0 && RAND:10
			CALL COUNTER_ABL, 5, 65, 66, 67, 68
		ELSEIF TALENT:淫壷 == 0 && TALENT:尿道狂 && RAND:10
			CALL COUNTER_ABL, 5, 88
		ELSE
			CALL COUNTER_ABL, 5, 65, 66, 67, 68, 88
		ENDIF
	ELSEIF CHECK("Ａ挿入")
		;淫壷と尻穴狂いの有無で確率にすごい偏りが出る
		IF TALENT:淫壷 && TALENT:尻穴狂い == 0 && RAND:10
			CALL COUNTER_ABL, 5, 65, 66, 67, 68
		ELSEIF TALENT:淫壷 == 0 && TALENT:尻穴狂い && RAND:10
			CALL COUNTER_ABL, 5, 75
		ELSE
			CALL COUNTER_ABL, 5, 65, 66, 67, 68, 75
		ENDIF
	ELSE
		CALL COUNTER_ABL, 5, 65, 66, 67, 68
	ENDIF
ENDIF
IF ABL:騎乗位
	;肛門騎乗位や尿道騎乗位はしてこないかも
	IF I:5 >= 70 && I:5 <= 79 && TALENT:尻穴狂い == 0 && ABL:Ａ感覚 < 5
		CALL COM_ABLE65
		IF RESULT
			SIF COND("発情期") || EXP:Ａ性交経験 < MIN(50, EXP:Ｖ性交経験)
				I:5 = 65
		ENDIF
	ELSEIF I:5 == 88 && TALENT:尿道狂 == 0
		CALL COM_ABLE65
		IF RESULT
			SIF COND("発情期") || EXP:尿道性交経験 < MIN(50, EXP:Ｖ性交経験)
				I:5 = 65
		ENDIF
	ENDIF

	ABL:騎乗位 += TALENT:好色 + TALENT:淫乱 + LOCAL:2 + ABL:腰靈活
	SIF MARK:淫紋 && TALENT:男性 == 0
		ABL:騎乗位 += (MARK:淫紋 + 1)/2

	SELECTCASE I:5
	CASE 65 TO 69
		SIF TARGET == ASSI
			I:5 = 65
		ABL:騎乗位 += MIN(ABL:Ｖ感覚, 10)/2 + TALENT:淫壷 + TALENT:Ｖ性向
		SIF INSERT("Ｖ挿入")
			ABL:騎乗位 += 5
		SIF COND("♀弱点", PLAYER)
			ABL:騎乗位 += 5
	CASE 75
		ABL:騎乗位 += MIN(ABL:Ａ感覚, 10)/2 + TALENT:尻穴狂い + TALENT:Ａ性向
		SIF INSERT("Ａ挿入")
			ABL:騎乗位 += 5
		SIF COND("肛門弱点", PLAYER)
			ABL:騎乗位 += 5
	CASE 88
		ABL:騎乗位 += MIN(ABL:尿道感覚, 10)/2 + TALENT:尿道狂 + TALENT:尿道性感
		SIF INSERT("尿道挿入")
			ABL:騎乗位 += 5
	ENDSELECT
ENDIF

;ABL:接吻,接吻
IF COND("調教側")
	CALL COUNTER_ABL, 6, 6
ELSE
	CALL COUNTER_ABL, 6, 6
ENDIF
IF ABL:接吻
	ABL:接吻 += TALENT:恋慕 + TALENT:蕩唇 + LOCAL:2 + ABL:舌靈活
	SIF COND("接吻弱点", PLAYER)
		ABL:接吻 += 5
ENDIF

;ABL:玩弄臀部,玩弄臀部
IF COND("調教側")
	CALL COUNTER_ABL, 7, 2, 142
ELSE
	CALL COUNTER_ABL, 7, 96
ENDIF
IF ABL:玩弄臀部 && EXP:玩弄Ａ経験 >= 20 && EXP:Ａ舐め経験 >= 5 && MAX(MIN(ABL:施虐属性, 5), MIN(ABL:奉仕精神, 10)/2) + ABL:PLAYER:受虐属性 >= 6
	ABL:玩弄臀部 += MIN(ABL:施虐属性, 5)/2 + MIN(ABL:PLAYER:受虐属性, 5)/2 + LOCAL:1
	;肛門調教知識
	SIF GETBIT(TALENT:調教知識, 3)
		ABL:玩弄臀部 += 5
ELSE
	ABL:玩弄臀部 = 0
	I:7 = 0
ENDIF

;ABL:强奸,TARGETの阴茎使用or逆強姦
IF COND("調教側")
	CALL COUNTER_ABL, 8, 60, 61, 64, 65, 71, 75, 83, 88, 140
ELSE
	IF TEQUIP:PLAYER:拘束 == 0 && CFLAG:前回拘束種類
		CALL COUNTER_ABL, 8, 4, 180
	ELSE
		CALL COUNTER_ABL, 8, 4, 120, 126, 180
	ENDIF
ENDIF
IF ABL:强奸
	ABL:强奸 += LOCAL:2 + ABL:腰靈活
	SIF PENIS(TARGET)
		ABL:强奸 += MIN(ABL:欲望, 10)/2
	;男性
	SIF TALENT:男性
		ABL:强奸 += 5
	SIF TEQUIP:PLAYER:拘束 == 0 && CFLAG:前回拘束種類
		ABL:强奸 += 5
ENDIF

;ABL:素股,素股
IF COND("調教側")
ELSE
	CALL COUNTER_ABL, 9, 80, 93, 94
ENDIF
SIF ABL:素股
	ABL:素股 += TALENT:献身 + LOCAL:1 + ABL:腰靈活/2

;ABL:道具
IF COND("調教側")
ELSE
	CALL COUNTER_ABL, 10
ENDIF
SIF ABL:道具
	ABL:道具 += LOCAL:2

TARGET = MEMO_TARGET


@COUNTER_ABL, ARG, ARG:1, ARG:2, ARG:3, ARG:4, ARG:5, ARG:6, ARG:7, ARG:8, ARG:9
#DIM LCOUNT
ABL:(70 + ARG) = 0
LOCAL = 1
FOR LCOUNT, 1, 10
	TRYCALLFORM COM_ABLE{ARG:LCOUNT}
	IF RESULT
		ABL:(70 + ARG) += 1
		SIF RAND:LOCAL == 0 || I:ARG == 0
			I:ARG = ARG:LCOUNT
		LOCAL += 1
	ENDIF
	SIF ARG:(LCOUNT + 1) == 0
		BREAK
NEXT

;-------------------------------------------------
;撃沈していないなら、恍惚格子
;-------------------------------------------------
@COUNTER_SYS_2
;-------------------------------------------------
;恍惚状態からの復帰判定
;-------------------------------------------------
IF STATE("恍惚", PLAYER)
	CALL COUNTER_REVIVAL
	;恍惚から復帰（恍惚变成了ターンは復活しません）
	SIF STATE("恍惚", PLAYER) == 0
		CALL KOJO_COUNTER, "恍惚から復帰"
ELSE
	CALL COUNTER_FASCINATION
ENDIF

;-------------------------------------------------
;脫力状態からの復帰判定
;-------------------------------------------------
IF STATE("脫力", PLAYER)
	IF TFLAG:脫力回合数 >= 9
		PRINTFORMW %CALLNAME:PLAYER%は脫力状態から復帰した！
		CALL REMOVE_STATE, PLAYER, "脫力"
	ELSE
		PRINTFORMW %CALLNAME:PLAYER%は脫力になっている……
		TFLAG:脫力回合数 += 1
	ENDIF
ENDIF

;-------------------------------------------------
;撃沈判定
;精力0時に助手は行動不可・主人は復活判定
;-------------------------------------------------
CALL COUNTER_DOWN

RETURN 0


;-------------------------------------------------
;被逆推た時の判定と処理
;ARGが基本の猶予時間で1.5～10秒の範囲
;-------------------------------------------------
@CHECK_OSHITAOSHI, ARG
;ARG msの時間の猶予で推倒の選択肢表示＆TEQUIP:推倒等の処理を行う
LOCAL = LIMIT(MULTIPLY(ARG, 100 - LIMIT(ABL:欲望 + ABL:技巧 - ABL:PLAYER:技巧, 0, 10)*10), 1500, 10000)
PRINTFORML [0]抵抗！
PRINTFORML [1]委身于下

IF CONFIG("制限時間")
	TINPUT LOCAL, 100, 1
ELSE
	CALL INPUT_SELECT, 2
ENDIF

IF RESULT
	TEQUIP:推倒 = 1
	;挿入中なら騎乗位へ
	SIF INSERT("挿入")
		TEQUIP:体位 = CLEARBITS(TEQUIP:体位, 0, 9) + 1p5
ENDIF

@COUNTER_FASCINATION
#DIM CHOICE
;恍惚、推倒判定
SIF TEQUIP:拘束 || TEQUIP:尿道探针 || COND("３Ｐ")
	RETURN 0
SIF STATE("撃沈", PLAYER) || STATE("恍惚", PLAYER)
	RETURN 0
;立位中は無理
SIF INSERT("立位")
	RETURN 0
;素質でやってこない
SIF TALENT:受け身
	RETURN 0

SELECTCASE SELECTCOM
CASE 280
	RETURN 0
ENDSELECT

TFLAG:恍惚確率 = 0
;恍惚確率を算出する
IF TCVAR:PLAYER:絶頂度 || CALCF("弱点突かれ", SELECTCOM)
	TFLAG:恍惚確率 = TCVAR:PLAYER:絶頂度*3 + (TALENT:謎之魅力 + TALENT:魅力)*2 - MIN(ABL:PLAYER:技巧, 10)

	;弱点の処理
	TFLAG:恍惚確率の弱点補正 = CALCF("弱点突かれ", SELECTCOM)*2 + CALCF("属性突かれ", TARGET)*2
	;二人推倒
	IF TEQUIP:Ｗ推倒
		TFLAG:恍惚確率 += TALENT:ASSI:謎之魅力 + TALENT:ASSI:魅力 + 2
		TFLAG:恍惚確率の弱点補正 += CALCF("弱点突かれ", SELECTCOM:1) + CALCF("属性突かれ", ASSI)
	ENDIF
	TFLAG:恍惚確率 += TFLAG:恍惚確率の弱点補正

	;酔酒
	SIF STATE("酔酒", PLAYER)
		TFLAG:恍惚確率 += 10

	;弱点優遇措置
	TFLAG:恍惚確率 = LIMIT(TFLAG:恍惚確率, TFLAG:恍惚確率の弱点補正, 100)
	;5％未満なら切捨て
	SIF TFLAG:恍惚確率 < 5
		TFLAG:恍惚確率 = 0
ENDIF

;恍惚、推倒判定
IF TFLAG:恍惚確率 > RAND:100
	CALL BLANKLINE
	PRINTFORML %CALLNAME:PLAYER%恍惚了……
	;推倒が可能か格子する
	CALL COM_ABLE176
	IF RESULT
		IF TEQUIP:PLAYER:理性主義
			FONTSTYLE 1
			PRINTFORMW 弹簧（原文：パチン）！
			FONTSTYLE 0
			PRINTFORMW 出乎意料之外、%CALLNAME:(ASSI:1)%发出巨大的声音使自己重新恢复理智！
		ELSE
			CHOICE = 0
			IF CONFIG("恍惚耐性") && BASE:PLAYER:精力 >= 2
				IF CONFIG("恍惚耐性") == 2
					CHOICE = 1
				ELSE
					CALL PRINT_SELECT, "委身于恍惚感/抵抗！（精力-１）"
					CHOICE = RESULT
				ENDIF
			ENDIF
			IF CHOICE
				BASE:PLAYER:精力 -= 1
			;	PRINTFORML 精力-１(%CALLNAME:PLAYER%)
				PRINTFORMW %CALLNAME:PLAYER%竭尽全力找回了自我！
				IF RAND:5 && TEQUIP:PLAYER:底力
					BASE:PLAYER:精力 += 2
					CALL PRINT_STRL, "黄色_因为底力回復了精力…！"
				ENDIF
			ELSE
				TEQUIP:推倒 = 1
				CALL ADD_STATE, PLAYER, "恍惚"
				;手下留情中なら、解除
				IF TEQUIP:手下留情
					TEQUIP:手下留情 = 0
					PRINTFORML 主导权被%CALLNAME:TARGET%夺走、%CALLNAME:PLAYER%不能从其手下逃脱…！
				ENDIF
				SIF CONFIG("恍惚耐性") == 0 || BASE:PLAYER:精力 < 2
					FORCEWAIT
				SIF COND("疲労") == 0
					CALL KOJO_COUNTER, "恍惚"
			ENDIF
		ENDIF
	ELSE
		PRINTFORML 、%CALLNAME:TARGET%将%CALLNAME:PLAYER%推倒了
	ENDIF
ENDIF

;以下、推倒状態でないなら推倒判定
SIF TEQUIP:推倒
	RETURN 0
;施虐属性が必要
SIF ABL:施虐属性 == 0
	RETURN 0
;やってこない状態
SIF TEQUIP:拘束 || TEQUIP:眼罩 || TEQUIP:浣腸 || TEQUIP:尿道探针 || STATE("恍惚", PLAYER) || CFLAG:マグロ
	RETURN 0
;大怪我
SIF TALENT:Ｖ損傷 || TALENT:Ａ損傷
	RETURN 0
;性癖の問題
SIF COND("性別嫌悪")
	RETURN 0
;今日は生が無理な時
SIF COND("女性主導生性交") == 0 && COND("Ａ熟達") == 0
	RETURN 0
;推倒が可能か格子する
CALL COM_ABLE176
SIF RESULT == 0
	RETURN 0

;体位によっては無理
SELECTCASE CONDS("体位")
CASE "正常位", "屈曲位", "後背位"
	RETURN 0
ENDSELECT

TFLAG:推倒確率 = MIN(ABL:欲望*2, 20) + (BASE:欲求不満/5) + (ABL:施虐属性 - ABL:受虐属性)*3 - COND("絶頂", PLAYER)*5 - NOWEX:絶頂数合計*20
SIF TALENT:強気
	TFLAG:推倒確率 += 15
SIF TALENT:淫乱
	TFLAG:推倒確率 += 10
SIF TALENT:好色
	TFLAG:推倒確率 += 5
SIF STATE("酔酒", TARGET)
	TFLAG:推倒確率 += 30
;イかされまくっても、推倒てこなくなる
SIF BASE:性欲 >= MAXBASE:性欲
	TFLAG:推倒確率 -= 20

;体力による補正(プラス减少補正はここまでで済ませる)
TFLAG:推倒確率 = TFLAG:推倒確率*BASE:体力/MAXBASE:体力
;欲情による補正
SELECTCASE PALAM:欲情
CASE IS < 500
	TIMES TFLAG:推倒確率, 0.10
CASE IS < 3000
	TIMES TFLAG:推倒確率, 0.30
CASE IS < 10000
	TIMES TFLAG:推倒確率, 0.50
CASE IS > 30000
	TIMES TFLAG:推倒確率, 1.20
ENDSELECT

;推倒頻度補正
SIF TCVAR:推倒頻度補正 > 0
	TFLAG:推倒確率 /= TCVAR:推倒頻度補正

;推倒確率が０以下の場合は当然押し倒さない
TFLAG:推倒確率 = LIMIT(TFLAG:推倒確率, 0, 100)

IF TFLAG:推倒確率 > RAND:100
	;推倒頻度減少
	TCVAR:推倒頻度補正 += 5 + RAND:6

	PRINTFORML %CALLNAME:TARGET%推倒了%CALLNAME:PLAYER%！

	IF TEQUIP:PLAYER:拘束
		PRINTFORMW が%CALLNAME:PLAYER%は拘束されているため抵抗出来ない…
		TEQUIP:推倒 = 1
		;挿入中なら騎乗位へ
		SIF INSERT("挿入")
			TEQUIP:体位 = CLEARBITS(TEQUIP:体位, 0, 9) + 1p5
	ELSE
		CALL CHECK_OSHITAOSHI, (100 - TFLAG:推倒確率 )*30
	ENDIF

	IF TEQUIP:推倒
		IF RAND:2 && TALENT:女性 && TALENT:不知羞恥 && (TALENT:強気 || ABL:施虐属性 + ABL:PLAYER:受虐属性 >= 5) && COND("室内") && USE_V(TARGET)
			CALL BLANKLINE
			;PRINTFORML %CALLNAME:TARGET%は飛び上がって%CALLNAME:PLAYER%の顔を太ももで挟み込むと、股間を押し付けて視界を奪いながら床に推倒てきた！
			VARSET LOCAL
			IF TEQUIP:六九式 == 0 && PENIS(PLAYER) && COND("指の使用")
				CALL COM_ABLE99
				LOCAL:1 = RESULT
			ENDIF
			IF INSERT("合体中") == 0 && PENIS(PLAYER) && COND("Ｖ熟達")
				CALL COM_ABLE65
				LOCAL:2 = RESULT
			ENDIF

			IF LOCAL:2 && RANDIF(2, LOCAL:1)
				PRINTFORML %CALLNAME:TARGET%被%CALLNAME:PLAYER%大骂、理所当然地用自己的阴道叼进了阴茎！

				CALL SET_INSERT, TARGET, PLAYER, 65
			ELSEIF LOCAL:1 && RAND:2
				PRINTFORM %CALLNAME:TARGET%用手抓住仰望已久的%CALLNAME:PLAYER%的阴茎、
				IF RAND:2
					PRINTFORML 把脸埋入股间、蹭在了鼻子上！
				ELSE
					PRINTFORML 把屁股压在脸上、坐了下来！
				ENDIF
				TEQUIP:六九式 = 90
				TEQUIP:PLAYER:六九式 = 1
				TEQUIP:面部騎乗 = 1
			ELSE
				PRINTFORML %CALLNAME:TARGET%仰面倒下了的、%CALLNAME:PLAYER%用膝盖跨过身体、慢慢地掉下腰用股间堵住鼻子和口！
				TEQUIP:面部騎乗 = 1
			ENDIF
		ENDIF
		CALL KOJO_COUNTER, "推倒"
		PRINTFORMW %CALLNAME:PLAYER%被压倒了……！
		IF TEQUIP:手下留情
			TEQUIP:手下留情 = 0
			PRINTFORMW 主导权被%CALLNAME:TARGET%夺走、%CALLNAME:PLAYER%不能从其手下逃脱…！
		ENDIF
		;情緒増加
		FLAG:情緒 += 5
	ELSE
		IF TALENT:恋慕 && PLAYER == MASTER
			PRINTFORMW %CALLNAME:PLAYER%抱住%CALLNAME:TARGET%、在耳边低声私语、让%CALLNAME:TARGET%把自己交给%CALLNAME:PLAYER%吧……
			IF CFLAG:マグロ == 0 && MOOD_HEART() >= 3
				PRINTFORMW %CALLNAME:TARGET%似乎把自己交给了%CALLNAME:PLAYER%……
				;値が２だとエロ終了時に０に戻される
				CFLAG:マグロ = 2
			ENDIF
		ELSE
			IF RAND:2 == 0
				PRINTFORMW 可是%CALLNAME:PLAYER%还是轻易地抵抗掉了！
			ELSE
				PRINTFORMW 可是%CALLNAME:PLAYER%巧妙地躲開了身体！
			ENDIF
			;情緒減少
			FLAG:情緒 -= 5
		ENDIF
	ENDIF
	CALL BLANKLINE
ENDIF

;基本的にはMASTERかASSIかPLAYER:1だけが対象
@COUNTER_DOWN
#DIM MEMO_LINECOUNT

;助手は指令を実行できなくなる
IF ASSI && STATE("撃沈", ASSI) == 0
	IF (ASSIPLAY || (SELECTCOM >= 160 && SELECTCOM <= 169) || TEQUIP:Ｗ推倒 || SELECTCOM:1 >= 0 || SELECTCOM:2 >= 0) && (BASE:ASSI:体力 < 500 || BASE:ASSI:精力 <= 0)
		CALL ASSI_DOWN, ASSI
		CALL KOJO_COUNTER, "助手が限界"
	ENDIF
ENDIF
;主人
IF BASE:MASTER:精力 <= 0 || BASE:MASTER:魂 <= 0
	PRINTFORMW %CALLNAME:MASTER%已经到达极限了……
	IF BASE:MASTER:魂 <= 0
		CALL PRINT_STR, "紅_＜復活！＞_W_"
		PRINTFORMW %CALLNAME:MASTER%用尽最后的力量复活了！
		BASE:MASTER:魂 = 1
	ENDIF
	PRINTFORMW ★★★★结束床戏★★★★
	CALL ADD_STATE, MASTER, "撃沈"
	CALL BLANKLINE
	MEMO_LINECOUNT = LINECOUNT

	CALL KOJO_COUNTER, "強制終了"

	SIF LINECOUNT == MEMO_LINECOUNT
		CLEARLINE 1

	BEGIN AFTERTRAIN
ENDIF

RETURN 0

;助手の撃沈アナウンス。３Ｐなどだと助手以外でもここに来る
@ASSI_DOWN, ARG
SIF STATE("撃沈", ARG) || (BASE:ARG:体力 >= 500 && BASE:ARG:精力 > 0)
	RETURN 0

CALL BLANKLINE
SIF ARG == ASSI
	PRINTFORML ★%TEXTS("助手の名称")%击沉★
PRINTFORMW %CALLNAME:ARG%はもう体力の限界だ。
PRINTFORMW 看来再让%CALLNAME:ARG%参加是不可能的……
CALL ADD_STATE, ARG, "撃沈"
CALL SETFLAG, "撃沈", ARG
;一部の指导者能力に影響
SIF ASSI == ASSI:1
	CALL RESET_ABL_ADVISER



@TARGET_DOWN
SIF CALCF("撃沈判定") == 0
	RETURN 0

;現在partnerが指导者(開始時は助手の立場)の場合には助手撃沈として処理をする
IF TARGET == ASSI:1 && CHECK_EXCHANGE("partner")
	CALL SETFLAG, "対象交代"
	CALL ASSI_DOWN, ASSI
	CALL KOJO_COUNTER, "助手が限界"
	RETURN 1
ENDIF

IF NOWEX:嘔吐
	PRINTFORMW %CALLNAME:TARGET%因為過度疲勞和精神上的苦痛而意気消沈…
	PRINTFORMW 好像有点过分勉强了……
ELSEIF TEQUIP:推倒
	PRINTFORMW %CALLNAME:TARGET%因疲劳过度而喘息着……
	PRINTFORMW 好像有点勉强了……
ELSE
	PRINTFORMW %CALLNAME:TARGET%因疲劳过度而气息奄奄……
	PRINTFORMW 好像有点过分勉强了……
	IF BASE:体力 <= 0
		;受虐属性有
		IF ABL:受虐属性 || ABL:欲望 >= 3 || COND("発情期")
			PRINTFORMW 可是、在%CALLNAME:TARGET%脸上也能看见欢喜的表情…。
		;それ以外で信頼Lvが1以上なら1下げる。推倒のときは除外
		;ELSEIF ABL:信頼 > 0 && ABL:信頼 < 5 && COND("欲求不満") == 0
		;	ABL:信頼 -= 1
		;	PRINTFORML %CALLNAME:TARGET%的信赖下降了一点。
		ENDIF
	ENDIF
ENDIF
CALL ADD_STATE, TARGET, "撃沈"
;BASE:精力 = MAX(BASE:精力, 1)
BASE:体力 = MAX(BASE:体力, 1)

IF BASE:体力 <= 0
	PRINTFORMW ★体力已经到了极限、虽然正在享受中、但还是结束了。★
ELSEIF NOWEX:嘔吐
	PRINTFORMW ★H的氛圍全部消失了、虽然正在享受中、但还是结束了。★
ELSE
	PRINTFORMW ★精力已经到了极限、虽然正在享受中、但还是结束了。★
ENDIF
BEGIN AFTERTRAIN


@COUNTER_REVIVAL
;復帰判定
SIF STATE("恍惚", PLAYER) == 0
	RETURN 0
;復帰確率を算出して代入(母乳を飲んでいると復帰率減少)
LOCAL = 10 + LIMIT(ABL:PLAYER:技巧 - ABL:技巧, -5, 5)*4 - EXP_GAIN("飲乳経験", PLAYER)*5
SIF BASE:PLAYER:精力*2 >= MAXBASE:PLAYER:精力
	LOCAL += 10
SIF COND("絶頂", PLAYER) == 0
	LOCAL += 5

;１Ｔごとに復帰率が５％ＵＰ
SELECTCASE TFLAG:恍惚回合数
CASE 0
	LOCAL = 0
CASEELSE
	LOCAL += (TFLAG:恍惚回合数 - 1)*5
ENDSELECT
;减少または100％を超えていたら修正
LOCAL = LIMIT(LOCAL, 0, 100)

IF LOCAL > RAND:100
	PRINTFORML %CALLNAME:PLAYER%清醒过来了！
	CALL REMOVE_STATE, PLAYER, "恍惚"
	;自動で推倒から復帰するのはオミット
	;IF LOCAL > RAND:100 && TEQUIP:Ｗ推倒 == 0 && STATE("バインド", PLAYER) == 0
	;	PRINTFORMW %CALLNAME:PLAYER%は被逆推状態から復帰した！
	;	TEQUIP:推倒 = 0
	;ENDIF
ELSE
	PRINTFORMW %CALLNAME:PLAYER%恍惚着……
	TFLAG:恍惚回合数 += 1
ENDIF
