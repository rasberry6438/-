@ダンジョン初期処理_奈落の大空洞
;ダンジョン構造の読み込み
;0でない時、そのマスは存在する
#DIM 深度
#DIM 分岐

VARSET ダンジョン構造配列_奈落の大空洞
ダンジョン階層記録 -= 1

ダンジョンサブタイトル = THE ABYSS
ダンジョンマス画像URL_伏せ状態 = 壁_洞窟
ダンジョン現在位置:0 = 3
ダンジョン現在位置:1 = 8
ダンジョン背景画像 = 背景_空洞

;スタート地点は必ず存在
;初期からオープン済みなので3を入れる
;ビット0：存在するか　ビット1：移動できるか　ビット2：マスをオープンするか（ビット１をONにしないと無意味）　ビット3：入れないがオープンする場合に使用
;ビット4以降：自由枠。主に宝箱の開閉やイベント達成フラグなどに使用
IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:3:8") == 0
	SETVAR @"ダンジョン構造配列_%ダンジョン名%:3:8", 3
ENDIF

FOR 深度, 1, 100
	LOCAL = 0
	FOR 分岐, 0, 9
		IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{深度}:{分岐}")
			;既にマス情報が入ってるなら飛ばす
			LOCAL = 1
			CONTINUE
		ELSEIF ENUMFUNCBEGINSWITH(@"ダンジョンマス情報_%ダンジョン名%_{深度}_{分岐}")
			LOCAL = 1
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:深度:分岐", 1
		ENDIF
	NEXT
	IF LOCAL
		ダンジョン最大深度 = 深度
	ENDIF
NEXT

@ダンジョン解説文_奈落の大空洞
詳細文文字列受け渡し変数 = 
詳細文文字列受け渡し変数 += "在开拓度假岛时发现的深不见底的空洞。<br>"
詳細文文字列受け渡し変数 += "由于魔力导致空间扭曲，通往深处的道路上盘踞着形形色色的魔物巢穴。<br>"
詳細文文字列受け渡し変数 += "必须做好应对任何敌人的万全准备。<br>"
詳細文文字列受け渡し変数 += "注意：若未能在单次探索中突破所有楼层，则需要重新开始。<br>"

;推奨レベルを返す
TRYCCALLFORM 奈落の大空洞_存在判定_{奈落の大空洞踏破フロア数 + 1}
	;次の未踏破フロアがあればその推奨レベル
	SIF RESULT > 0
		RETURN RESULT
CATCH
ENDCATCH
;なければ最後の踏破フロアの推奨レベル
CALLFORM 奈落の大空洞_存在判定_{奈落の大空洞踏破フロア数}

ランダムダンジョンフラグ = 1

RETURN RESULT


@ダンジョン突入時特殊処理_奈落の大空洞
#DIM 推奨レベル
#DIM ランダムモード解禁フラグ

CALL ダンジョン解説文_奈落の大空洞
PRINTFORML ■■奈落大空洞　　推荐Lv：25～
PRINTL
HTML_PRINT 詳細文文字列受け渡し変数
PRINTL
PRINTL 从第几层开始？
ランダムモード解禁フラグ = 0
FOR LOCAL, 0, 奈落の大空洞踏破フロア数 + 1
	TRYCCALLFORM 奈落の大空洞_存在判定_{LOCAL + 1}
		推奨レベル = RESULT
		SIF 推奨レベル <= 0
			BREAK
	CATCH
		ランダムモード解禁フラグ = 1
		BREAK
	ENDCATCH
	PRINTBUTTON @"[{LOCAL}] 地下%TOFULL(TOSTR(LOCAL + 1))%层起　　推荐Lv：{推奨レベル}", LOCAL
	PRINTL
NEXT
IF ランダムモード解禁フラグ
	PRINTBUTTON @"[998] 前往更深层的奈落　　推荐Lv：？？？", 998
	PRINTL
ENDIF
PRINTL
PRINTBUTTON "[999] 返回", 999
PRINTL
BINPUT
SELECTCASE RESULT
	CASE 999
		RETURN -1
	CASE 998
		ダンジョン階層記録 = 1
		CALLF 奈落の大空洞_深層_正体(1)
		CALL DUNGEON_MAIN_LOOP("奈落の大空洞")
	CASEELSE
		ダンジョン階層記録 = RESULT * -1
		CALL DUNGEON_MAIN_LOOP("奈落の大空洞")
ENDSELECT


@敵討伐後処理_ダンジョン固有_奈落の大空洞(討伐エネミー数)
;ダンジョン内で戦闘した後に呼ばれる関数、主にダンジョンごとのドロップアイテム取得に使用
;まだ敵データはリセットしていないので敵BATTLE_STATEで色々情報は取得可能
#DIM 討伐エネミー数
#DIM ドロップ確率
#DIMS ドロップアイテム

ドロップ確率 = 5 * 討伐エネミー数
ドロップアイテム = 星晶碎片
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 1 * 討伐エネミー数
ドロップアイテム = 赤铜古纹
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)


@奈落の大空洞_追加レベル補正算出
#DIM 最大レベル
#DIM キャラ数
#DIM ループ用

IF ダンジョン階層記録 && (ダンジョン階層記録 * -1) > 奈落の大空洞踏破フロア数
	;未踏破の場合、無し
	RETURN 0
ELSE
	;踏破済の場合、パーティレベルに応じてさらに敵が強くなる
	最大レベル = 0
	キャラ数 = 0
	FOR ループ用, 0, 14
		SIF ループ用 > 3 && ループ用 < 10
			CONTINUE
		SIF BATTLE_STATE:ループ用:キャラ登録番号 < 1
			CONTINUE
		SIF BATTLE_STATE:ループ用:Lv > 最大レベル
			最大レベル = BATTLE_STATE:ループ用:Lv
		;キャラ数もカウント
		キャラ数 ++
	NEXT
	CALLFORM 奈落の大空洞_存在判定_{ダンジョン階層記録 * -1}
	RETURN MAX(0, 最大レベル - RESULT) * MIN(4, キャラ数) / 4
ENDIF


@ダンジョンマス情報_奈落の大空洞_3_8(ARGS)
#DIM CONST マス深度 = 3
#DIM CONST マス分岐 = 8

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_洞窟
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "0_5")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			IF (ダンジョン階層記録 * -1) > 奈落の大空洞踏破フロア数
				WSTR:(K++) = 已抵达未探索区域。
				KSTR:(K++) = 请保持警戒前进。
			ELSE
				WSTR:(K++) = 到达目标区域。
				KSTR:(K++) = 展开周边调查推进空洞探索吧。
			ENDIF
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = 展开周边调查推进空洞探索吧。
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_奈落の大空洞_0_5(ARGS)
#DIM CONST マス深度 = 0
#DIM CONST マス分岐 = 5
#DIM CONST ウェーブ番号 = 1

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_洞窟
		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "2_1")
	CASE "マスイベント"
		IF GETBIT(ダンジョン構造配列_奈落の大空洞:マス深度:マス分岐, 4) == 0
			;最初に訪れた時
			WSTR:(K++) = 魔物盘踞在此，似乎无法绕行深入。
			KSTR:(K++) = 要挑战强敌吗？
			KSTR:(K++) = BUTTON_[确定]
			KSTR:(K++) = BUTTON_[取消]
			CALL メッセージ欄表示用関数(,,,0)
			BINPUTS
			SELECTCASE RESULTS
				CASE "[确定]"
					CALL 口上変数初期化
					WSTR:(K++) = %CALLNAME:PLAYER%一行架起武器向强敌发起挑战！
					CALL 奈落の大空洞_追加レベル補正算出
					CALLFORM 奈落の大空洞_エネミーセット_{ダンジョン階層記録 * -1}_{ウェーブ番号}(RESULT)
					CALL 雑魚敵遭遇汎用処理
					IF RESULT == 0
						;勝利時のみ先へ進む
						CALL 口上変数初期化
						WSTR:(K++) = %CALLNAME:PLAYER%一行成功讨伐了强敌！
						TRYCALLFORM 奈落の大空洞_エネミー勝利後_{ダンジョン階層記録 * -1}_{ウェーブ番号}
						CALL メッセージ欄表示用関数(,,,0)
						CALL 接続ルート全開放処理(マス深度, マス分岐)
						SETBIT ダンジョン構造配列_奈落の大空洞:マス深度:マス分岐, 4
					ENDIF
				CASE "[取消]"
					CALL 口上変数初期化
					WSTR:(K++) = 敌方可是强敌，需做好万全准备再挑战。
					CALL メッセージ欄表示用関数(,,,0)
			ENDSELECT
		ELSE
			KSTR:(K++) = 强敌早已被讨伐。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
			CALL メッセージ欄表示用関数(,,,0)
		ENDIF
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_奈落の大空洞_2_1(ARGS)
#DIM CONST マス深度 = 2
#DIM CONST マス分岐 = 1
#DIM CONST ウェーブ番号 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_洞窟
		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "6_2")
	CASE "マスイベント"
		IF GETBIT(ダンジョン構造配列_奈落の大空洞:マス深度:マス分岐, 4) == 0
			;最初に訪れた時
			WSTR:(K++) = 魔物盘踞在此，似乎无法绕行深入。
			KSTR:(K++) = 要挑战强敌吗？
			KSTR:(K++) = BUTTON_[确定]
			KSTR:(K++) = BUTTON_[取消]
			CALL メッセージ欄表示用関数(,,,0)
			BINPUTS
			SELECTCASE RESULTS
				CASE "[确定]"
					CALL 口上変数初期化
					WSTR:(K++) = %CALLNAME:PLAYER%一行架起武器向强敌发起挑战！
					CALL 奈落の大空洞_追加レベル補正算出
					CALLFORM 奈落の大空洞_エネミーセット_{ダンジョン階層記録 * -1}_{ウェーブ番号}(RESULT)
					CALL 雑魚敵遭遇汎用処理
					IF RESULT == 0
						;勝利時のみ先へ進む
						CALL 口上変数初期化
						WSTR:(K++) = %CALLNAME:PLAYER%一行成功讨伐了强敌！
						TRYCALLFORM 奈落の大空洞_エネミー勝利後_{ダンジョン階層記録 * -1}_{ウェーブ番号}
						CALL メッセージ欄表示用関数(,,,0)
						CALL 接続ルート全開放処理(マス深度, マス分岐)
						SETBIT ダンジョン構造配列_奈落の大空洞:マス深度:マス分岐, 4
					ENDIF
				CASE "[取消]"
					CALL 口上変数初期化
					WSTR:(K++) = 敌方可是强敌，需做好万全准备再挑战。
					CALL メッセージ欄表示用関数(,,,0)
			ENDSELECT
		ELSE
			KSTR:(K++) = 强敌早已被讨伐。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
			CALL メッセージ欄表示用関数(,,,0)
		ENDIF
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_奈落の大空洞_6_2(ARGS)
#DIM CONST マス深度 = 6
#DIM CONST マス分岐 = 2
#DIM CONST ウェーブ番号 = 3

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_洞窟
		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "5_7")
	CASE "マスイベント"
		IF GETBIT(ダンジョン構造配列_奈落の大空洞:マス深度:マス分岐, 4) == 0
			;最初に訪れた時
			WSTR:(K++) = 魔物盘踞在此，似乎无法绕行深入。
			KSTR:(K++) = 要挑战强敌吗？
			KSTR:(K++) = BUTTON_[确定]
			KSTR:(K++) = BUTTON_[取消]
			CALL メッセージ欄表示用関数(,,,0)
			BINPUTS
			SELECTCASE RESULTS
				CASE "[确定]"
					CALL 口上変数初期化
					WSTR:(K++) = %CALLNAME:PLAYER%一行架起武器向强敌发起挑战！
					CALL 奈落の大空洞_追加レベル補正算出
					CALLFORM 奈落の大空洞_エネミーセット_{ダンジョン階層記録 * -1}_{ウェーブ番号}(RESULT)
					CALL 雑魚敵遭遇汎用処理
					IF RESULT == 0
						;勝利時のみ先へ進む
						CALL 口上変数初期化
						WSTR:(K++) = %CALLNAME:PLAYER%一行成功讨伐了强敌！
						TRYCALLFORM 奈落の大空洞_エネミー勝利後_{ダンジョン階層記録 * -1}_{ウェーブ番号}
						CALL メッセージ欄表示用関数(,,,0)
						CALL 接続ルート全開放処理(マス深度, マス分岐)
						SETBIT ダンジョン構造配列_奈落の大空洞:マス深度:マス分岐, 4
					ENDIF
				CASE "[取消]"
					CALL 口上変数初期化
					WSTR:(K++) = 敌方可是强敌，需做好万全准备再挑战。
					CALL メッセージ欄表示用関数(,,,0)
			ENDSELECT
		ELSE
			KSTR:(K++) = 强敌早已被讨伐。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
			CALL メッセージ欄表示用関数(,,,0)
		ENDIF
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_奈落の大空洞_5_7(ARGS)
#DIM CONST マス深度 = 5
#DIM CONST マス分岐 = 7
#DIM CONST ウェーブ番号 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_洞窟
		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "4_6")
	CASE "マスイベント"
		IF GETBIT(ダンジョン構造配列_奈落の大空洞:マス深度:マス分岐, 4) == 0
			;最初に訪れた時
			WSTR:(K++) = 魔物盘踞在此，似乎无法绕行深入。
			KSTR:(K++) = 要挑战强敌吗？
			KSTR:(K++) = BUTTON_[确定]
			KSTR:(K++) = BUTTON_[取消]
			CALL メッセージ欄表示用関数(,,,0)
			BINPUTS
			SELECTCASE RESULTS
				CASE "[确定]"
					CALL 口上変数初期化
					WSTR:(K++) = %CALLNAME:PLAYER%一行架起武器向强敌发起挑战！
					CALL 奈落の大空洞_追加レベル補正算出
					CALLFORM 奈落の大空洞_エネミーセット_{ダンジョン階層記録 * -1}_{ウェーブ番号}(RESULT)
					CALL 雑魚敵遭遇汎用処理
					IF RESULT == 0
						;勝利時のみ先へ進む
						CALL 口上変数初期化
						WSTR:(K++) = %CALLNAME:PLAYER%一行成功讨伐了强敌！
						TRYCALLFORM 奈落の大空洞_エネミー勝利後_{ダンジョン階層記録 * -1}_{ウェーブ番号}
						CALL メッセージ欄表示用関数(,,,0)
						CALL 接続ルート全開放処理(マス深度, マス分岐)
						SETBIT ダンジョン構造配列_奈落の大空洞:マス深度:マス分岐, 4
					ENDIF
				CASE "[取消]"
					CALL 口上変数初期化
					WSTR:(K++) = 敌方可是强敌，需做好万全准备再挑战。
					CALL メッセージ欄表示用関数(,,,0)
			ENDSELECT
		ELSE
			KSTR:(K++) = 强敌早已被讨伐。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
			CALL メッセージ欄表示用関数(,,,0)
		ENDIF
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_奈落の大空洞_4_6(ARGS)
#DIM CONST マス深度 = 4
#DIM CONST マス分岐 = 6
#DIM CONST ウェーブ番号 = 5

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_洞窟
		ダンジョンマス画像URL_重ね表示 = エネミーアイコン_赤
	CASE "接続先"
	CASE "マスイベント"
		WSTR:(K++) = 在通往下一层级的岩壁前，盘踞着极其强大的魔物。
		WSTR:(K++) = 这恐怕是本层最强的魔物，显然无法绕行深入。
		KSTR:(K++) = 要挑战强敌吗？
		KSTR:(K++) = BUTTON_[确定]
		KSTR:(K++) = BUTTON_[取消]
		CALL メッセージ欄表示用関数(,,,0)
		BINPUTS
		SELECTCASE RESULTS
			CASE "[确定]"
				CALL 口上変数初期化
				WSTR:(K++) = %CALLNAME:PLAYER%一行架起武器向强敌发起挑战！
				CALL 奈落の大空洞_追加レベル補正算出
				CALLFORM 奈落の大空洞_エネミーセット_{ダンジョン階層記録 * -1}_{ウェーブ番号}(RESULT)
				CALL 雑魚敵遭遇汎用処理
				IF RESULT == 0
					;勝利時のみ先へ進む
					CALL 口上変数初期化
					IF (ダンジョン階層記録 * -1) > 奈落の大空洞踏破フロア数
						奈落の大空洞踏破フロア数 = ダンジョン階層記録 * -1
						WSTR:(K++) = %CALLNAME:PLAYER%以下成功击败强敌，开辟了通往下一阶层的道路！
					ELSEIF ダンジョン階層記録 == 0
						WSTR:(K++) = %CALLNAME:PLAYER%一行成功讨伐了强敌！
						TRYCALLFORM 奈落の大空洞_エネミー勝利後_{ダンジョン階層記録 * -1}_{ウェーブ番号}
						CALL メッセージ欄表示用関数(,,,0)

						CALL 口上変数初期化
						WSTR:(K++) = %CALLNAME:PLAYER%以下朝着更深层的道路继续前进…
						CALL メッセージ欄表示用関数(,,,0)
						;次階層生成
						ダンジョン階層記録 = 1
						CALL ダンジョン初期処理_奈落の大空洞
						CALL 踏破マス開放処理
						CALL 接続ルート全開放処理((ダンジョン現在位置:0), (ダンジョン現在位置:1))
						CALL 画面再描画
						RETURN
					ELSE
						WSTR:(K++) = %CALLNAME:PLAYER%一行成功讨伐了强敌！
					ENDIF
					TRYCALLFORM 奈落の大空洞_エネミー勝利後_{ダンジョン階層記録 * -1}_{ウェーブ番号}
					CALL メッセージ欄表示用関数(,,,0)
					;帰還処理
					ダンジョンクリアフラグ_奈落の大空洞 = 1
					CALL 口上変数初期化
					ダンジョン終了状況 = 踏破達成
				ENDIF
			CASE "[取消]"
				CALL 口上変数初期化
				WSTR:(K++) = 敌方可是强敌，需做好万全准备再挑战。
				CALL メッセージ欄表示用関数(,,,0)
		ENDSELECT
		CALL 画面再描画
ENDSELECT
