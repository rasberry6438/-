

@ダンジョン初期処理_魔導書の謎解き試練
;ダンジョン構造の読み込み
;0でない時、そのマスは存在する
#DIM 深度
#DIM 分岐

ダンジョンサブタイトル = THE BOOK OF RIDDLES
ダンジョンマス画像URL_伏せ状態 = 壁_遺跡
ダンジョン現在位置:0 = 0
ダンジョン現在位置:1 = 4
ダンジョン背景画像 = 背景_遺跡

;スタート地点は必ず存在
;初期からオープン済みなので3を入れる
;ビット0：存在するか　ビット1：移動できるか　ビット2：マスをオープンするか（ビット１をONにしないと無意味）　ビット3：入れないがオープンする場合に使用
;ビット4以降：自由枠。主に宝箱の開閉やイベント達成フラグなどに使用
IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{ダンジョン現在位置:0}:{ダンジョン現在位置:1}") == 0
	SETVAR @"ダンジョン構造配列_%ダンジョン名%:{ダンジョン現在位置:0}:{ダンジョン現在位置:1}", 3
ENDIF

FOR 深度, 1, 100
	LOCAL = 0
	FOR 分岐, 0, 9
		IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{深度}:{分岐}")
			;既にマス情報が入ってるなら飛ばす
			LOCAL = 1
			CONTINUE
		ELSEIF ENUMFUNCBEGINSWITH(@"ダンジョンマス情報_%ダンジョン名%_{深度}_{分岐}")
			LOCAL = 1
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:深度:分岐", 1
		ENDIF
	NEXT
	IF LOCAL
		ダンジョン最大深度 = 深度
	ENDIF
NEXT

@ダンジョン解説文_魔導書の謎解き試練

詳細文文字列受け渡し変数 = 
詳細文文字列受け渡し変数 += "被邀请至度假地的异世界客人——芙莉莲一行被囚禁在了魔导书中。<br>"
詳細文文字列受け渡し変数 += "你与星晶兽艾拉一同前去迎接芙莉莲等人，<br>"
詳細文文字列受け渡し変数 += "为此踏入了设有解谜试炼的魔导书内部。<br>"
詳細文文字列受け渡し変数 += "<br>"
詳細文文字列受け渡し変数 += "迷宫出处：葬送的芙莉莲<br>"

;推奨レベルを返す
RETURN 1

@敵討伐後処理_ダンジョン固有_魔導書の謎解き試練(討伐エネミー数)
#DIM 討伐エネミー数
;ダンジョン内で戦闘した後に呼ばれる関数、主にダンジョンごとのドロップアイテム取得に使用
;今回アイテムドロップはないので記述なし

;---------------------------------------------------------------------
;マップ構造
;---------------------------------------------------------------------
;イベントミニマップなのでほぼ一本道
;---------------------------------------------------------------------

@ダンジョンマス情報_魔導書の謎解き試練_0_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 0
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "1_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 翻开魔导书进入其中。
			WSTR:(K++) = 周围的景色瞬间切换，似乎转移到了石砌遗迹般的建筑内部。
			WSTR:(K++) = 身旁可见星晶兽艾拉的身影，看来成功汇合并未被分散。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「哼……虽然演出效果很古老，但术式倒是挺新潮……
			WSTR:(K++) = 　制作时间最多也就两、三年前吧」
			CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 艾拉正兴致勃勃地调查周围，看她乐在其中真是再好不过。
			WSTR:(K++) = 书内空间虽然昏暗，但稍远处可见人影。
			WSTR:(K++) = 应该就是先进入书中的客人们吧，继续前进汇合吧。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = 稍远处可见人影。
			KSTR:(K++) = 应该就是先进入书中的客人们吧。
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_魔導書の謎解き試練_1_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 1
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "4_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = 与芙莉莲、菲伦、修塔尔克汇合了。
			CALL 再視聴確認(再戦闘_なし)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]芙莉莲"),100,,,1,1)
			立ち絵_フリーレン = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
			立ち絵_フェルン = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[战士]修塔尔克"),102,,,1,1)
			立ち絵_シュタルク = %立ち絵リソース記録%
			WSTR:(K++) = 带着艾拉靠近刚才看到的人影。
			WSTR:(K++) = 其中一人是白发扎成双马尾的纤弱少女。
			WSTR:(K++) = 另一人是留着紫黑色长发、身披黑袍的年轻女性。
			WSTR:(K++) = 最后是背负巨斧的红发青年。
			WSTR:(K++) = %CALLNAME:PLAYER%邀请至度假村的「芙莉莲」「菲伦」「修塔尔克」应该就是他们没错。
			WSTR:(K++) = %CALLNAME:PLAYER%向三人搭话，说明了事情原委。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「原来如此，是书中的空间啊。
			WSTR:(K++) = 　这个世界也有有趣的魔法呢」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"芙莉莲",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「明白我们被滞留的原因了。
			WSTR:(K++) = 　是因为修塔尔克大人发动攻击的惩罚吧」
			CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「对、对不起啦……我还以为是魔物嘛」
			CALL メッセージ欄表示用関数(立ち絵_シュタルク,"修塔尔克",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 三人身旁立着身披奢华长袍的骸骨石像。
			WSTR:(K++) = 石像手持刻有文字的碑板，似乎能通过魔力反应显现文字。
			WSTR:(K++) = 看来这就是『解谜』的机关，攻击石像等行为会被视为犯规。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「一次攻击会导致一小时无法解答。
			WSTR:(K++) = 　若多次攻击可能触发其他惩罚。
			WSTR:(K++) = 　还是老老实实解谜最稳妥吧」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"芙莉莲",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 芙莉莲举手投足尽显资深魔法使风范。
			WSTR:(K++) = 虽说是试炼，但解谜程度应该很快就能破解。
			WSTR:(K++) = 星晶兽艾拉也充满自信，看来能轻松脱困。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「喂喂，在说什么呢。
			WSTR:(K++) = 　解谜该由你来啊，我的契约者」
			CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 这家伙突然说什么呢。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「要是我或那边的魔法使立刻解开就太无趣了吧。
			WSTR:(K++) = 　这种时候看着别人苦恼的样子才有趣啊」
			CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「虽然不知道有没有趣，不过确实。偶尔进行这种修行也不错。
			WSTR:(K++) = 　菲伦，来试试解谜吧」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"芙莉莲",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 在芙莉莲的催促下，菲伦老实地开始挑战解谜。
			WSTR:(K++) = 艾拉用充满期待的眼神望过来。
			WSTR:(K++) = 没办法，%CALLNAME:PLAYER%也来挑战解谜吧。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT




@ダンジョンマス情報_魔導書の謎解き試練_4_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 4
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		KSTR:(K++) = 该找谁打听呢？
		KSTR:(K++) = BUTTON_[与修塔尔克交谈]_（小提示）
		KSTR:(K++) = BUTTON_[与菲伦交谈]_（大提示）
		KSTR:(K++) = BUTTON_[与芙莉莲交谈]_（近乎答案）
		KSTR:(K++) = BUTTON_[还是算了]
		CALL メッセージ欄表示用関数(,,,0)
		CALL 口上変数初期化
		$LOOP_MESSAGE
		INPUTS
		SELECTCASE RESULTS
			CASE "[与修塔尔克交谈]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[战士]修塔尔克"),102,,,1,1)
				立ち絵_シュタルク = %立ち絵リソース記録%
				WSTR:(K++) = 试着和红发战士搭话吧。关于这个谜题，你怎么看？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「哎、我？我超不擅长这种的啦……
				WSTR:(K++) = 　不过，应该没有平局对吧？
				WSTR:(K++) = 　总感觉……要是能巧妙组合的话，就能完美契合吧？」
				CALL メッセージ欄表示用関数(立ち絵_シュタルク,"修塔尔克",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 修塔尔克正嗯嗯唔唔地苦思冥想。
				WSTR:(K++) = 确实没有平局这部分似乎是重要情报。再仔细想想吧。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[与菲伦交谈]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
				立ち絵_フェルン = %立ち絵リソース記録%
				WSTR:(K++) = 试着和黑发魔法使搭话吧。关于这个谜题，你怎么看？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「这个嘛……
				WSTR:(K++) = 　菲泽大人的剪刀次数格外突出这点很令人在意。
				WSTR:(K++) = 　我打算从这里入手分析」
				CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 菲伦正用魔杖在地面写写画画思考着。
				WSTR:(K++) = 菲泽的剪刀次数确实很特殊，再仔细想想吧。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[与芙莉莲交谈]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]芙莉莲"),100,,,1,1)
				立ち絵_フリーレン = %立ち絵リソース記録%
				WSTR:(K++) = 试着和白发魔法使搭话吧。关于这个谜题，你怎么看？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「在我们世界也是自古流传的逻辑系谜题呢。
				WSTR:(K++) = 　这种时候啊，要试着限定条件来思考。
				WSTR:(K++) = 　比如说，当菲泽出剪刀时兰德尔的手是……」
				CALL メッセージ欄表示用関数(立ち絵_フリーレン,"芙莉莲",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「哎呀，再说下去就等于公布答案了。到此为止吧，魔法使」
				CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 被艾拉捂住嘴的芙莉莲发出不甘心的闷哼。
				WSTR:(K++) = 限定条件吗。再仔细想想吧。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[还是算了]"
				CALL 口上変数初期化
			CASEELSE
				CLEARLINE 1
				REUSELASTLINE  
				GOTO LOOP_MESSAGE
		ENDSELECT
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_魔導書の謎解き試練_4_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 4
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "4_2")
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "6_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 查看石像手持的谜题：
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			KSTR:(K++) = 此处有进行过十次猜拳的两位男子——菲泽与兰德尔。
			KSTR:(K++) = 菲泽出石头１次，剪刀７次，布２次。
			KSTR:(K++) = 兰德鲁出石头３次，剪刀３次，布４次。
			KSTR:(K++) = 若没有一次平局，那么获胜次数更多的一方是谁？
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			WSTR:(K++) = 看来是个相当棘手的谜题。
			WSTR:(K++) = 或许该找人商量获取提示。
			WSTR:(K++) = 实在解不开的话，也可以放弃让艾拉直接解答。
			WSTR:(K++) = 要听取提示请前往上方区域，要提交答案或放弃请前往右侧区域。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = 此处有进行过十次猜拳的两位男子——菲泽与兰德尔。
			KSTR:(K++) = 菲泽出石头１次，剪刀７次，布２次。
			KSTR:(K++) = 兰德鲁出石头３次，剪刀３次，布４次。
			KSTR:(K++) = 若没有一次平局，那么获胜次数更多的一方是谁？
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_6_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フェルン
マス深度 = 6
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "7_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = 向第一道谜题发起挑战。
			CALL 再視聴確認(1)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			WSTR:(K++) = 那么，该如何作答呢？
			KSTR:(K++) = BUTTON_[菲泽获胜更多]
			KSTR:(K++) = BUTTON_[兰德尔获胜更多]
			KSTR:(K++) = BUTTON_[双方持平]
			KSTR:(K++) = BUTTON_[放弃并让艾拉解答]
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			$LOOP_MESSAGE
			INPUTS
			SELECTCASE RESULTS
				CASE "[菲泽获胜更多]", "[兰德尔获胜更多]"
					WSTR:(K++) = 「回答错误！！」
					CALL メッセージ欄表示用関数(,"石像之声",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 石像发出声响的同时，%CALLNAME:PLAYER%头顶倾泻下大量冷水。
					WSTR:(K++) = 虽不至于受伤，但全身都湿透了……
					WSTR:(K++) = 看来是错误惩罚，重新思考吧。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
						CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
						ダンジョン現在位置:0 = 4
						ダンジョン現在位置:1 = 4
					ENDIF
					RETURN 0
				CASE "[双方持平]"
					CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
					立ち絵_フェルン = %立ち絵リソース記録%
					WSTR:(K++) = 「认可汝之睿智……」
					CALL メッセージ欄表示用関数(,"石像之声",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 石像发出声响的同时，通往下一房间的门扉开启了。
					WSTR:(K++) = 看来顺利答对了。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「菲泽大人与兰德尔大人都是五胜五败。即正确答案是持平。
					WSTR:(K++) = 　能答对真是太好了」
					CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 菲伦似乎也推导出了正确答案。
					WSTR:(K++) = 昂首阔步前往下一房间吧。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
				CASE "[放弃并让艾拉解答]"
					CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
					立ち絵_フェルン = %立ち絵リソース記録%
					WSTR:(K++) = 「真拿你没办法啊，我的契约者。
					WSTR:(K++) = 　就让身为星晶兽的我来解答说明吧」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 拜托您了艾拉大人。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「首先要关注『没有平局』和『菲泽最多的剪刀』这两点。
					WSTR:(K++) = 　由此可推导出『菲泽出剪刀时＝兰德尔出石头＋兰德尔出布』的情况。
					WSTR:(K++) = 　此时菲泽已确定获得4胜3败，兰德尔则是3胜4败」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「接下来只需考虑剩余情况『兰德尔出剪刀时＝菲泽出石头＋菲泽出布』。
					WSTR:(K++) = 　合计后双方都是５胜５败。这就是答案的机关」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 艾拉带着得意的神情输入答案后，通往下一房间的门扉开启了。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「能答对真是太好了」
					CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 菲伦似乎自行解开了谜题。
					WSTR:(K++) = %CALLNAME:PLAYER%虽然中途放弃，但重整精神前往下一房间吧。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
				CASEELSE
					CLEARLINE 1
					REUSELASTLINE  
					GOTO LOOP_MESSAGE
			ENDSELECT
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_魔導書の謎解き試練_7_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 7
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		IF 初来訪マス判定用フラグ
			;移動直後はマスイベント発動しないので、移動先のルート開放をここで行う
			CALL 接続ルート全開放処理(8, 4)
		ENDIF
		ダンジョン現在位置:0 = 8
		ダンジョン現在位置:1 = 4
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_魔導書の謎解き試練_8_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 8
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "11_4")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 7
		ダンジョン現在位置:1 = 4
		CALL 画面再描画
ENDSELECT




@ダンジョンマス情報_魔導書の謎解き試練_11_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 11
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		KSTR:(K++) = 该找谁打听呢？
		KSTR:(K++) = BUTTON_[与修塔尔克交谈]_（小提示）
		KSTR:(K++) = BUTTON_[与菲伦交谈]_（大提示）
		KSTR:(K++) = BUTTON_[与芙莉莲交谈]_（近乎答案）
		KSTR:(K++) = BUTTON_[还是算了]
		CALL メッセージ欄表示用関数(,,,0)
		CALL 口上変数初期化
		$LOOP_MESSAGE
		INPUTS
		SELECTCASE RESULTS
			CASE "[与修塔尔克交谈]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[战士]修塔尔克"),102,,,1,1)
				立ち絵_シュタルク = %立ち絵リソース記録%
				WSTR:(K++) = 试着和修塔尔克搭话吧。关于这个谜题，你怎么看？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「稍等一下。好复杂啊……
				WSTR:(K++) = 　呃，最多是10人。啊，自己和恋人不能握手对吧？那应该是8人……」
				CALL メッセージ欄表示用関数(立ち絵_シュタルク,"修塔尔克",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 修塔尔克正嗯嗯唔唔地苦思冥想。
				WSTR:(K++) = 不过「握手人数最多８人」这点似乎是重要提示，再仔细想想吧。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[与菲伦交谈]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
				立ち絵_フェルン = %立ち絵リソース記録%
				WSTR:(K++) = 试着和费伦搭话吧。关于这个谜题，你怎么看？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「既然所有人的回答都不同……
				WSTR:(K++) = 　我认为9人的答案应该分别是０，１，２，３，４，５，６，７，８人。
				WSTR:(K++) = 　但问题在于如何组合这些数字……」
				CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 菲伦正用魔杖在地面写写画画思考着。
				WSTR:(K++) = 答案范围确实是０到８人没错。
				WSTR:(K++) = 再想想能否从这里推导出组合方式吧。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[与芙莉莲交谈]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]芙莉莲"),100,,,1,1)
				立ち絵_フリーレン = %立ち絵リソース記録%
				WSTR:(K++) = 试着和芙莉莲搭话吧。关于这个谜题，你怎么看？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「虽然有点复杂，但解法是重复同样的思路。
				WSTR:(K++) = 　不要单独考虑每个人，试着以每对恋人为单位思考。
				WSTR:(K++) = 　回答８人者的恋人，应该对应回答几人者呢。那就是……」
				CALL メッセージ欄表示用関数(立ち絵_フリーレン,"芙莉莲",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「哎呀，再说下去就等于公布答案了。到此为止吧，魔法使」
				CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 被艾拉捂住嘴的芙莉莲发出不甘心的闷哼。
				WSTR:(K++) = 以每对恋人为单位思考吗，再仔细想想吧。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[还是算了]"
				CALL 口上変数初期化
			CASEELSE
				CLEARLINE 1
				REUSELASTLINE  
				GOTO LOOP_MESSAGE
		ENDSELECT
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_魔導書の謎解き試練_11_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 11
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "11_2")
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "13_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 来到新房间，这里的石像同样手持谜题石板。
			WSTR:(K++) = 查看石像手持的谜题：
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			KSTR:(K++) = 此处有恋人罗密欧与朱丽叶。
			KSTR:(K++) = 他们邀请了４对恋人（共计８人）举办派对。
			KSTR:(K++) = 派对上，１０名参与者只与「初次见面的人」握手。
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			KSTR:(K++) = 派对结束后，罗密欧询问了其他９名参与者「与多少人握手」。
			KSTR:(K++) = 结果９人的回答各不相同。
			KSTR:(K++) = 那么朱丽叶与多少人握过手？
			KSTR:(K++) = 补充说明：不存在「在派对上初次见到自己恋人」的情况。 
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			WSTR:(K++) = 看来是个相当困难的谜题。
			WSTR:(K++) = 或许该找人商量获取提示。
			WSTR:(K++) = 实在解不开的话，也可以放弃让艾拉直接解答。
			WSTR:(K++) = 要听取提示请前往上方区域，要提交答案或放弃请前往右侧区域。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = 此处有恋人罗密欧与朱丽叶。
			KSTR:(K++) = 他们邀请了４对恋人（共计８人）举办派对。
			KSTR:(K++) = 派对上，１０名参与者只与「初次见面的人」握手。
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			KSTR:(K++) = 派对结束后，罗密欧询问了其他９名参与者「与多少人握手」。
			KSTR:(K++) = 结果９人的回答各不相同。
			KSTR:(K++) = 那么朱丽叶与多少人握过手？
			KSTR:(K++) = 补充说明：不存在「在派对上初次见到自己恋人」的情况。 
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_13_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フェルン
マス深度 = 13
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "15_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = 向第二道谜题发起挑战。
			CALL 再視聴確認(1)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			WSTR:(K++) = 那么，该如何作答呢？
			KSTR:(K++) = BUTTON_[输入数字]
			KSTR:(K++) = BUTTON_[放弃并让艾拉解答]
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			$LOOP_MESSAGE
			INPUTS
			SELECTCASE RESULTS
				CASE "[输入数字]"
					DRAWLINE
					PRINTL 请输入任意数字（半角数字）
					DRAWLINE
					INPUT
					SELECTCASE RESULT
						CASE 4
							CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
							立ち絵_フェルン = %立ち絵リソース記録%
							WSTR:(K++) = 「认可汝之睿智……」
							CALL メッセージ欄表示用関数(,"石像之声",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 石像发出声响的同时，通往下一房间的门扉开启了。
							WSTR:(K++) = 看来顺利答对了。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
							WSTR:(K++) = 「罗密欧大人与朱丽叶大人都与４人握过手。
							WSTR:(K++) = 　总算答对了」
							CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 菲伦似乎也推导出了正确答案。
							WSTR:(K++) = 昂首阔步前往下一房间吧。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
						CASEELSE
							WSTR:(K++) = 「回答错误！！」
							CALL メッセージ欄表示用関数(,"石像之声",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 石像发出声响的同时，%CALLNAME:PLAYER%头顶倾泻下大量冷水。
							WSTR:(K++) = 虽不至于受伤，但全身都湿透了……
							WSTR:(K++) = 看来是错误惩罚，重新思考吧。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
							IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
								CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
								ダンジョン現在位置:0 = 11
								ダンジョン現在位置:1 = 4
							ENDIF
							RETURN 0
					ENDSELECT
				CASE "[放弃并让艾拉解答]"
					CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
					立ち絵_フェルン = %立ち絵リソース記録%
					WSTR:(K++) = 「真拿你没办法啊，我的契约者。
					WSTR:(K++) = 　就让身为星晶兽的我来解答说明吧」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 拜托您了艾拉大人。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「首先要关注『所有人握手次数不同』和『不存在初次见到恋人者』这两点。
					WSTR:(K++) = 　由此可推导出『答案范围是０人～８人』。
					WSTR:(K++) = 　接下来思考『回答８人者的恋人』」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「既然存在回答８人者，说明『除８人者及其恋人外，其他人都至少与其握过一次手』。
					WSTR:(K++) = 　通过排除法可确定『回答８人者的恋人必定是回答０人者』」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 　「接下来同理。回答７人者的情况是『除０人者、自己及恋人外，与所有人握过手』，
					WSTR:(K++) = 　因此除７人者及其恋人外，其他人都与其握过两次手。即『７人者的恋人是１人者』」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「组合规律为８－０、７－１、６－２、５－３，剩下的最后组合是４－４。
					WSTR:(K++) = 　因此朱丽叶的握手人数是４人。
					WSTR:(K++) = 　由于罗密欧未被询问，即使与朱丽叶人数相同也不矛盾。
					WSTR:(K++) = 　那么，你理解到哪一步了？」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 艾拉带着得意的神情输入答案后，通往下一房间的门扉开启了。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「总算答对了」
					CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 菲伦似乎自行解开了谜题。
					WSTR:(K++) = %CALLNAME:PLAYER%虽然中途放弃，但重整精神前往下一房间吧。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
				CASEELSE
					CLEARLINE 1
					REUSELASTLINE  
					GOTO LOOP_MESSAGE
			ENDSELECT
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_15_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 15
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		IF 初来訪マス判定用フラグ
			;移動直後はマスイベント発動しないので、移動先のルート開放をここで行う
			CALL 接続ルート全開放処理(16, 4)
		ENDIF
		ダンジョン現在位置:0 = 16
		ダンジョン現在位置:1 = 4
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_魔導書の謎解き試練_16_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 16
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "19_4")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 15
		ダンジョン現在位置:1 = 4
		CALL 画面再描画
ENDSELECT




@ダンジョンマス情報_魔導書の謎解き試練_19_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 19
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		KSTR:(K++) = 该找谁打听呢？
		KSTR:(K++) = BUTTON_[与菲伦交谈]_（小提示）
		KSTR:(K++) = BUTTON_[与芙莉莲交谈]_（大提示）
		KSTR:(K++) = BUTTON_[与修塔尔克交谈]_（近乎答案）
		KSTR:(K++) = BUTTON_[还是算了]
		CALL メッセージ欄表示用関数(,,,0)
		CALL 口上変数初期化
		$LOOP_MESSAGE
		INPUTS
		SELECTCASE RESULTS
			CASE "[与菲伦交谈]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
				立ち絵_フェルン = %立ち絵リソース記録%
				WSTR:(K++) = 试着和费伦搭话吧。关于这个谜题，你怎么看？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「提亚玛特大人２人与尤格多拉希尔大人３人等于科罗萨斯大人……
				WSTR:(K++) = 　提亚玛特大人的体重这样无法确定啊……」
				CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 菲伦正用魔杖在地面写写画画思考着。
				WSTR:(K++) = 确实，仅凭这些条件无法确定各自体重。
				WSTR:(K++) = 或许星晶兽的体重与答案无关？再仔细想想吧。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[与芙莉莲交谈]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]芙莉莲"),100,,,1,1)
				立ち絵_フリーレン = %立ち絵リソース記録%
				WSTR:(K++) = 试着和芙莉莲搭话吧。关于这个谜题，你怎么看？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「关键在于『我』所指代的内容。
				WSTR:(K++) = 　这种谜题也令人怀念呢。
				WSTR:(K++) = 　以前和辛美尔他们旅行时，也挑战过解谜迷宫……」
				CALL メッセージ欄表示用関数(立ち絵_フリーレン,"芙莉莲",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 芙莉莲开始追忆往昔，虽然有趣但似乎会很长。
				WSTR:(K++) = 思考『我』所指代的内容吗。再仔细想想吧。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[与修塔尔克交谈]"
				CALLF 顔グラ表示用文字列関数(キャラ検索("[战士]修塔尔克"),102,,,1,1)
				立ち絵_シュタルク = %立ち絵リソース記録%
				WSTR:(K++) = 试着和修塔尔克搭话吧。关于这个谜题，你怎么看？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「啊……这根本是谐音梗吧……
				WSTR:(K++) = 　因为石像的外形」
				CALL メッセージ欄表示用関数(立ち絵_シュタルク,"修塔尔克",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「哎呀，再说下去就等于公布答案了。到此为止吧」
				CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 被艾拉捂住嘴的修塔尔克发出唔嘎的闷哼。
				WSTR:(K++) = 石像的外形吗，出题石像究竟有什么特征呢？
				WSTR:(K++) = 或许该回去看看之前的区域，再仔细想想吧。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			CASE "[还是算了]"
				CALL 口上変数初期化
			CASEELSE
				CLEARLINE 1
				REUSELASTLINE  
				GOTO LOOP_MESSAGE
		ENDSELECT
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_魔導書の謎解き試練_19_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 19
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "19_2")
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "21_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 来到新房间，这里的石像同样手持谜题石板。
			WSTR:(K++) = 石板还注明这是最后的谜题。
			WSTR:(K++) = 查看石像手持的谜题：
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			KSTR:(K++) = 此处有体重100吨的星晶兽科罗萨斯。
			KSTR:(K++) = 提亚玛特的体重不足科罗萨斯的一半，尤格多拉希尔的体重比提亚玛特更轻。
			KSTR:(K++) = 提亚玛特２人的体重与尤格多拉希尔３人的体重之和等于科罗萨斯的体重。
			KSTR:(K++) = 那么，我究竟多少吨？ 
			CALL メッセージ欄表示用関数()
			CALL 口上変数初期化
			WSTR:(K++) = 这……？似乎是别具一格的谜题。
			WSTR:(K++) = 或许该找人商量获取提示。
			WSTR:(K++) = 实在解不开的话，也可以放弃让艾拉直接解答。
			WSTR:(K++) = 要听取提示请前往上方区域，要提交答案或放弃请前往右侧区域。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = 此处有体重100吨的星晶兽科罗萨斯。
			KSTR:(K++) = 提亚玛特的体重不足科罗萨斯的一半，尤格多拉希尔的体重比提亚玛特更轻。
			KSTR:(K++) = 提亚玛特２人的体重与尤格多拉希尔３人的体重之和等于科罗萨斯的体重。
			KSTR:(K++) = 那么，我究竟多少吨？ 
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_21_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フェルン
マス深度 = 21
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "23_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = 向第三道谜题发起挑战。
			CALL 再視聴確認(1)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			WSTR:(K++) = 那么，该如何作答呢？
			KSTR:(K++) = BUTTON_[输入答案]
			KSTR:(K++) = BUTTON_[放弃并让艾拉解答]
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			$LOOP_MESSAGE
			INPUTS
			SELECTCASE RESULTS
				CASE "[输入答案]"
					DRAWLINE
					PRINTL 请输入任意答案（全角）
					DRAWLINE
					INPUTS
					SELECTCASE RESULTS
						CASE "スケルトン", "スケル"
							CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
							立ち絵_フェルン = %立ち絵リソース記録%
							WSTR:(K++) = 「认可汝之睿智……」
							CALL メッセージ欄表示用関数(,"石像之声",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 石像发出声响的同时，通往下一房间的门扉开启了。
							WSTR:(K++) = 看来顺利答对了。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
							WSTR:(K++) = 「……根本和体重无关嘛」
							CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 菲伦似乎也没想通，气鼓鼓地嘟着脸颊。
							WSTR:(K++) = 看来所有谜题都已完结。
							WSTR:(K++) = 继续前进脱离魔导书吧。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
						CASEELSE
							WSTR:(K++) = 「回答错误！！」
							CALL メッセージ欄表示用関数(,"石像之声",,0)
							CALL 口上変数初期化
							WSTR:(K++) = 石像发出声响的同时，%CALLNAME:PLAYER%头顶倾泻下大量冷水。
							WSTR:(K++) = 虽不至于受伤，但全身都湿透了……
							WSTR:(K++) = 看来是错误惩罚，重新思考吧。
							CALL メッセージ欄表示用関数(,,,0)
							CALL 口上変数初期化
							IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
								CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
								ダンジョン現在位置:0 = 11
								ダンジョン現在位置:1 = 4
							ENDIF
							RETURN 0
					ENDSELECT
				CASE "[放弃并让艾拉解答]"
					CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
					立ち絵_フェルン = %立ち絵リソース記録%
					WSTR:(K++) = 「真拿你没办法啊，我的契约者。
					WSTR:(K++) = 　就让身为星晶兽的我来解答说明吧」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 拜托您了艾拉大人。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「首先要关注『需要回答的是「我」而非星晶兽』这点。
					WSTR:(K++) = 　也就是说１００吨体重之类的全是幌子。
					WSTR:(K++) = 　这是基于前两题逻辑谜题设计的陷阱题」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「那么『我』究竟指什么？正是出题的石像本身。
					WSTR:(K++) = 　还记得石像的外形吗？没错，是『身披奢华长袍的骸骨石像』。
					WSTR:(K++) = 　说到骸骨和『吨』的关联……不难联想到『骷髅（スケルトン）』的谐音梗吧」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「嘛，就是个冷笑话。
					WSTR:(K++) = 　能不能灵光一现运气成分很大。答不上也不用沮丧」
					CALL メッセージ欄表示用関数("顔エラ","星晶兽艾拉",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 艾拉带着得意的神情输入答案后，最后的门扉开启了。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
					WSTR:(K++) = 「……根本和体重无关嘛」
					CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
					CALL 口上変数初期化
					WSTR:(K++) = 菲伦似乎也没想通，气鼓鼓地嘟着脸颊。
					WSTR:(K++) = %CALLNAME:PLAYER%虽然中途放弃，但所有谜题都已完结。
					WSTR:(K++) = 继续前进脱离魔导书吧。
					CALL メッセージ欄表示用関数(,,,0)
					CALL 口上変数初期化
				CASEELSE
					CLEARLINE 1
					REUSELASTLINE  
					GOTO LOOP_MESSAGE
			ENDSELECT
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_魔導書の謎解き試練_23_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_フリーレン
#DIMS 立ち絵_フェルン
#DIMS 立ち絵_シュタルク
マス深度 = 23
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_遺跡
		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			$再視聴表示
			KSTR:(K++) = 继续前进脱离魔导书吧。
			CALL 再視聴確認(1)
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			CALLF 顔グラ表示用文字列関数(キャラ検索("[葬送]芙莉莲"),100,,,1,1)
			立ち絵_フリーレン = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[芙莉莲的弟子]菲伦"),101,,,1,1)
			立ち絵_フェルン = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[战士]修塔尔克"),102,,,1,1)
			立ち絵_シュタルク = %立ち絵リソース記録%
			WSTR:(K++) = 解开谜题来到最深处，悬浮着一本魔导书。
			WSTR:(K++) = 在魔导书里发现魔导书虽然有些奇妙，但总之似乎能通过它习得魔法。
			WSTR:(K++) = 究竟记载着怎样的魔法呢？芙莉莲拿起魔导书哗啦啦翻动。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「这是……『翻开书本时直达上次阅读页面的魔法』呢」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"芙莉莲",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 用书签不就好了。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「芙莉莲大人就喜欢收集这种奇特的魔法」
			CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 本人满意就好……
			WSTR:(K++) = 总之虽然有些波折，但总算能脱困了。
			WSTR:(K++) = 向三人表达希望他们在度假村好好休憩的欢迎之意。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「时隔许久能在城镇安眠，真令人期待」
			CALL メッセージ欄表示用関数(立ち絵_シュタルク,"修塔尔克",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「异世界什么的，连我也确实是初次体验。
			WSTR:(K++) = 　想尽可能多采购些异世界的魔导书呢」
			CALL メッセージ欄表示用関数(立ち絵_フリーレン,"芙莉莲",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「请别太挥霍了，旅费本就不宽裕」
			CALL メッセージ欄表示用関数(立ち絵_フェルン,"菲伦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 在三人喧闹声中脱离魔导书。
			WSTR:(K++) = 星晶兽艾拉似乎对解谜游戏很满足，露出愉悦神情。
			WSTR:(K++) = 虽是相当棘手的迷宫，但全员无伤也算圆满收场吧。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = [葬送]芙莉莲开始造访度假村了！
			WSTR:(K++) = [芙莉莲的弟子]菲伦开始造访度假村了！
			WSTR:(K++) = [战士]修塔尔克开始造访度假村了！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CFLAG:(キャラ検索("[葬送]芙莉莲")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[芙莉莲的弟子]菲伦")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[战士]修塔尔克")):招待不可フラグ = 0

			IF 滞在キャラ上限 - 滞在キャラ数 - 集客人数 - FLAG:滞在キャラ枠先確保分 > 2
				解放キャラ招待:(FINDELEMENT(解放キャラ招待, 0)) = キャラ検索("[葬送]芙莉莲")
				解放キャラ招待:(FINDELEMENT(解放キャラ招待, 0)) = キャラ検索("[芙莉莲的弟子]菲伦")
				解放キャラ招待:(FINDELEMENT(解放キャラ招待, 0)) = キャラ検索("[战士]修塔尔克")
				FLAG:滞在キャラ枠先確保分 += 3
			ENDIF

			ダンジョン終了状況 = 踏破達成
			ダンジョンクリアフラグ_魔導書の謎解き試練 = 1
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT




