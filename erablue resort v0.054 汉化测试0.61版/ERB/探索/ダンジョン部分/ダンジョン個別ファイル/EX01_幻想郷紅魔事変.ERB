

@ダンジョン初期処理_幻想郷紅魔異変
;ダンジョン構造の読み込み
;0でない時、そのマスは存在する
#DIM 深度
#DIM 分岐

ダンジョンサブタイトル = THE MIST OF SCARLET
ダンジョンマス画像URL_伏せ状態 = 壁_森
ダンジョン現在位置:0 = 0
ダンジョン現在位置:1 = 4
ダンジョン背景画像 = 背景_紅い霧砂浜

;スタート地点は必ず存在
;初期からオープン済みなので3を入れる
;ビット0：存在するか　ビット1：移動できるか　ビット2：マスをオープンするか（ビット１をONにしないと無意味）　ビット3：入れないがオープンする場合に使用
;ビット4以降：自由枠。主に宝箱の開閉やイベント達成フラグなどに使用
IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{ダンジョン現在位置:0}:{ダンジョン現在位置:1}") == 0
	SETVAR @"ダンジョン構造配列_%ダンジョン名%:{ダンジョン現在位置:0}:{ダンジョン現在位置:1}", 3
ENDIF

FOR 深度, 1, 100
	LOCAL = 0
	FOR 分岐, 0, 9
		IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{深度}:{分岐}")
			;既にマス情報が入ってるなら飛ばす
			LOCAL = 1
			CONTINUE
		ELSEIF ENUMFUNCBEGINSWITH(@"ダンジョンマス情報_%ダンジョン名%_{深度}_{分岐}")
			LOCAL = 1
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:深度:分岐", 1
		ENDIF
	NEXT
	IF LOCAL
		ダンジョン最大深度 = 深度
	ENDIF
NEXT

@ダンジョン解説文_幻想郷紅魔異変

詳細文文字列受け渡し変数 = 
詳細文文字列受け渡し変数 += "红雾在度假村弥漫，导致运营受阻。<br>"
詳細文文字列受け渡し変数 += "你为消除雾气潜入了异世界之门。<br>"
詳細文文字列受け渡し変数 += "在名为「幻想乡」的异世界寻求解决之策。<br>"
詳細文文字列受け渡し変数 += "<br>"
詳細文文字列受け渡し変数 += "迷宫出处：东方project<br>"

;推奨レベルを返す
RETURN 16

@敵討伐後処理_ダンジョン固有_幻想郷紅魔異変(討伐エネミー数)
#DIM 討伐エネミー数
;ダンジョン内で戦闘した後に呼ばれる関数、主にダンジョンごとのドロップアイテム取得に使用
;今回アイテムドロップはないので記述なし

;---------------------------------------------------------------------
;固有戦闘開始時処理
;---------------------------------------------------------------------
;霊夢と魔理沙の加勢バフ
;---------------------------------------------------------------------
@固有戦闘開始時処理_特殊_灵梦的助力_紅魔事変()
;ここ２行はエラー回避のためのもの。おまじない程度においておくこと
戦闘行動キャラ = 0
CALL アビ対象選択テンプレート_自己のみ
;バフ付け文章は出さないので1を入れておく
アビテンプレート用_アビ名表示済フラグ = 1
;大元のバフセット（効果なし）
CALL アビ汎用変数文字列リセット
アビ汎用文字列:バフ・デバフ枠 = 灵梦的助力_紅魔事変
アビ汎用文字列:バフ・デバフ対象能力 = 灵梦的助力_紅魔事変
アビ汎用変数:持続ターン = -1
アビ汎用変数:消去不可オプション = 1
アビ汎用変数:特殊表示オプション = 1
アビ汎用文字列:適用範囲 = 味方全体
CALL アビテンプレート_有利効果_バフ効果セット
;回避UP部分
CALL アビ汎用変数文字列リセット
アビ汎用文字列:バフ・デバフ枠 = 灵梦的助力_紅魔事変_回避率
アビ汎用文字列:バフ・デバフ対象能力 = 回避率
アビ汎用変数:効果量 = 15
アビ汎用文字列:適用範囲 = 味方全体
CALL アビテンプレート_有利効果_付随バフ効果セット("灵梦的助力_紅魔事変")
;カウンター部分
CALL アビ汎用変数文字列リセット
アビ汎用文字列:バフ・デバフ枠 = 灵梦的助力_紅魔事変_援護攻撃
アビ汎用文字列:バフ・デバフ対象能力 = 特殊反応_回避時
アビ汎用文字列:適用範囲 = 味方全体
CALL アビテンプレート_有利効果_付随バフ効果セット("灵梦的助力_紅魔事変")

;メッセージは出さないのでここでリセット
CALL アビテンプレ変数リセット

@特殊反応_回避時_灵梦的助力_紅魔事変_援護攻撃(バフ番号, 攻撃者隊列, 回避記録順)
#DIM 回避記録順
#DIM 攻撃者隊列
#DIM バフ番号
#DIMS 立ち絵_霊夢

;立ち絵リソース記録に必要な画像のリソースを生成する
CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),100,,,1,1)
立ち絵_霊夢 = %立ち絵リソース記録%

;顔グラ込みのセリフを出す
WSTR:(K++) = 「%TEXTR("看招！/破绽百出呢/得手啦！")%」
CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
CALL 口上変数初期化

;攻撃処理
CALL アビテンプレ変数リセット
CALL アビ対象選択テンプレート_指定(攻撃者隊列)
アビテンプレート用_アビ名 = 霊夢の援護攻撃

アビ汎用文字列:実行時メッセージ１ = 灵梦的支援攻击！
アビ汎用変数:効果量 = 500
CALL アビテンプレート_ダメージ処理_光属性

CALL アビテンプレート用_表示メッセージ変換処理
CALL メッセージ欄表示用関数(,,,0)
CALL 口上変数初期化

@バフ・デバフ特殊表示_灵梦的助力_紅魔事変(隊列番号, バフ・デバフ行数)
#DIM 隊列番号
#DIM バフ・デバフ行数
VARSET LOCALS

PRINTFORML 灵梦的助力
PRINTFORML 回避率+15％・回避时灵梦发动援护攻击［不可驱散］
PRINTFORML 持续回合：永久

@固有戦闘開始時処理_特殊_魔理沙的助力_紅魔事変()
;ここ２行はエラー回避のためのもの。おまじない程度においておくこと
戦闘行動キャラ = 0
CALL アビ対象選択テンプレート_自己のみ
;バフ付け文章は出さないので1を入れておく
アビテンプレート用_アビ名表示済フラグ = 1
;大元のバフセット（効果なし）
CALL アビ汎用変数文字列リセット
アビ汎用文字列:バフ・デバフ枠 = 魔理沙的助力_紅魔事変
アビ汎用文字列:バフ・デバフ対象能力 = 攻撃力
アビ汎用変数:効果割合 = 30
アビ汎用変数:持続ターン = -1
アビ汎用変数:消去不可オプション = 1
アビ汎用変数:特殊表示オプション = 1
アビ汎用文字列:適用範囲 = 味方全体
CALL アビテンプレート_有利効果_バフ効果セット

;メッセージは出さないのでここでリセット
CALL アビテンプレ変数リセット

@バフ・デバフ特殊表示_魔理沙的助力_紅魔事変(隊列番号, バフ・デバフ行数)
#DIM 隊列番号
#DIM バフ・デバフ行数
VARSET LOCALS

PRINTFORML 魔理沙的助力
PRINTFORML 攻击力+30％［不可驱散］
PRINTFORML 持续回合：永久

@固有戦闘開始時処理_特殊_霊夢と魔理沙的助力_紅魔事変()
CALL 固有戦闘開始時処理_特殊_灵梦的助力_紅魔事変()
CALL 固有戦闘開始時処理_特殊_魔理沙的助力_紅魔事変()

;---------------------------------------------------------------------
;マップ構造
;---------------------------------------------------------------------
;イベントミニマップなのでほぼ一本道、途中ちょっとだけ分岐
;---------------------------------------------------------------------

@ダンジョンマス情報_幻想郷紅魔異変_0_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 0
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "2_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 被红雾笼罩的湖畔。
			CALL 再視聴確認(1)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			WSTR:(K++) = 穿越异世界之门，循着红雾前进后抵达了一个世界。
			WSTR:(K++) = 这里就是幻想乡吗。
			WSTR:(K++) = 四周弥漫着浓密的红雾，视野不佳……但看起来像是湖畔。
			WSTR:(K++) = 当然，植被与空气都与度假区截然不同。感觉像是东方空域的群岛……
			WSTR:(K++) = 总之在这里我们是外来者。雾气又浓，小心前进吧。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_2_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 2
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "4_4")
	CASE "マスイベント"
		KSTR:(K++) = 似乎是相当大的湖泊，寒气在飘荡……
		CALL 接続ルート全開放処理(マス深度, マス分岐)
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_4_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 4
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "5_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 红雾中，有漆黑的球体？正在飞舞……
			WSTR:(K++) = 那是什么。没有线索，要追上去看看吗？
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = 周围没有特别异常之处。
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_5_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 5
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "7_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 与漆黑球体少女战斗过的地方。
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[宵暗的妖怪]露米娅"),100,,,1,1)
			LOCALS = %立ち絵リソース記録%
			CALLF 任意顔グラ表示用文字列関数(キャラ検索("[宵暗的妖怪]露米娅"),"顔_デフォルト_差分_表情",101)
			LOCALS:1 = %立ち絵リソース記録%
			WSTR:(K++) = 追逐漆黑球体时来到一片树林。
			WSTR:(K++) = 球体触碰树木……
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「好痛」
			CALL メッセージ欄表示用関数(,"？？？",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……从漆黑球体中传来了声音（还伴随着咚的吃痛声）。
			WSTR:(K++) = 球体如溶解般消失，现出按着额头的金发少女。
			WSTR:(K++) = 是用什么魔法手段在飞行吗？
			WSTR:(K++) = 总之似乎能沟通，试着询问吧。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「好痛……咦？你是谁？」
			CALL メッセージ欄表示用関数(LOCALS:1,"漆黑球体少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 回答说是调查红雾的人。有什么头绪吗？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「嗯，不太清楚呢。
			WSTR:(K++) = 　我也可以提问吗？
			WSTR:(K++) = 　你是可以抓来吃掉的人类吗？」
			CALL メッセージ欄表示用関数(LOCALS,"漆黑球体少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……以为是少女，但似乎是食人的非人存在。
			WSTR:(K++) = 表露天真杀意的漆黑球体少女袭来！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv10_漆黑球体少女
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 4
				ダンジョン現在位置:1 = 4
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;勝利後or読み返し中
			WSTR:(K++) = 勉强击退了少女。
			WSTR:(K++) = 看来在幻想乡，单凭肉身飞行是常态。
			WSTR:(K++) = 没有人影的原因，除了刚才那种存在，或许也因为人们都在天上飞……？
			WSTR:(K++) = 总之没得到有用线索。去别处调查吧。
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:7:4")
			SETBIT LOCAL, 1
			SETBIT LOCAL, 2
			CLEARBIT LOCAL, 3
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:7:4", LOCAL
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_7_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 7
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 8
		ダンジョン現在位置:1 = 4
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 接続ルート全開放処理(8, 4)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_8_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 8
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "10_4")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 7
		ダンジョン現在位置:1 = 4
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_10_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 10
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "13_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 看见两个人影从上空掠过。
			WSTR:(K++) = 虽然之前有漆黑球体少女的先例……但毫无线索。
			WSTR:(K++) = 这次或许是友善人物，追上去看看吧。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = 前方有两个人影掠过。
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT




@ダンジョンマス情報_幻想郷紅魔異変_13_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_チルノ
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_霊夢
マス深度 = 13
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "14_2")
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "14_6")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 这里是遭遇灵梦、魔理沙并与妖精战斗的场所。
			KSTR:(K++) = 与灵梦一起喝茶：前往Ａ区域
			KSTR:(K++) = 追赶飞走的魔理沙：前往Ｂ区域
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[湖上的冰精]琪露诺"),100,,,1,1)
			立ち絵_チルノ = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),101,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),102,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			WSTR:(K++) = 这是战斗的气息吗？传来物体破裂声与强烈寒气。
			WSTR:(K++) = 或许能与其中一方友好接触，靠近看看吧。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「冷死了啦！简直要得空调病了！」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"红白少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「穿短袖对身体不好啊！」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔女风少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「做好和英国牛一起被冷冻保存的觉悟了吗！」
			CALL メッセージ欄表示用関数(立ち絵_チルノ,"蓝发幼女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 蓝发幼女背后悬浮着冰之羽翼。看来并非人类。
			WSTR:(K++) = 虽能自由操控冰魔法，但似乎智商不太高的样子。
			WSTR:(K++) = 对面的两位少女……大概是……人类。
			WSTR:(K++) = 表示要助阵，向两位少女搭话。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「交给你啦，冻死人了！」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔女风少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「啊、那就拜托咯」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"红白少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……没想到会被直接托付啊！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv12_生有冰翼的少女
			敵BATTLE_STATE_STR:4:エネミー名 = Lv9_宛如妖精的少女
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 10
				ダンジョン現在位置:1 = 4
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),101,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),102,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%

			WSTR:(K++) = 「哦～挺能干的嘛」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"红白少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「这面孔在本地没见过啊？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔女风少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 两位少女分别自称灵梦与魔理沙。
			WSTR:(K++) = 向啪啪鼓掌的二人点头致意后开始说明。
			WSTR:(K++) = 如此这般，因故来到幻想乡……
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「嘿～经营观光地？好想体验郊游啊～」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 魔理沙指着灵梦嘀咕「真悠闲」。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「我知道啦，就算要去也得等异变解决后。
			WSTR:(K++) = 　……不过现在也没掌握什么线索。
			WSTR:(K++) = 　总觉得问题出在这附近呢」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「雾气也是这里最浓。
			WSTR:(K++) = 　这附近发生过什么吗？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「嗯～好像有人带着洋馆搬过来了……？」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 原来如此，那座洋馆就是首要目标吧？
			WSTR:(K++) = 找到后需要联络吗……虽然也没有联络手段。
			WSTR:(K++) = 该跟随哪边行动呢？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「你直接解决不也挺好嘛」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「那就先到先得咯。我要往这边走」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 话音未落，魔理沙已骑着扫帚飞离。
			WSTR:(K++) = 灵梦叹息道：
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「虽然可能在这边……但身子有点发冷。
			WSTR:(K++) = 　我先喝杯茶再出发」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 说着便坐在路边，从袖中取出竹筒。
			WSTR:(K++) = 难得遇到友善的本地人。该跟随哪边呢……
			WSTR:(K++) = 与灵梦一起喝茶：前往Ａ区域
			WSTR:(K++) = 追赶飞走的魔理沙：前往Ｂ区域
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:2")
			SETBIT LOCAL, 3
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:2", LOCAL
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:6")
			SETBIT LOCAL, 3
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:6", LOCAL
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_14_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_霊夢
#DIM 返答フラグ
マス深度 = 14
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原
		ダンジョンマス画像URL_重ね表示 = Ａマーク
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "15_2")
	CASE "マスイベント"
		IF 分岐封印判定(条件_クリア済み, "14-2", "14-6")
			KSTR:(K++) = 该选项在迷宫通关前被锁定。
			;フラグをリセット
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:2")
			SETBIT LOCAL, 3
			CLEARBIT LOCAL, 2
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:2", LOCAL
			CALL メッセージ欄表示用関数(,,,0)
			CALL 画面再描画
		ELSE
			RFLAG:ダンジョン再視聴フラグ = 0
			IF 初来訪マス判定用フラグ
				;最初に訪れた時
				SETBIT RFLAG:ダンジョン再視聴フラグ, 0
				SETBIT RFLAG:ダンジョン再視聴フラグ, 1
				SETBIT RFLAG:ダンジョン再視聴フラグ, 10
			ELSE
				KSTR:(K++) = 与灵梦同行。
				CALL 再視聴確認(1)
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
				;立ち絵リソース記録に必要な画像のリソースを生成する
				CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),100,,,1,1)
				立ち絵_霊夢 = %立ち絵リソース記録%
				WSTR:(K++) = 「嗯？有事吗？」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
				CALL 口上変数初期化
				KSTR:(K++) = 要跟随灵梦吗？
				KSTR:(K++) = BUTTON_[确定]
				KSTR:(K++) = BUTTON_[取消]
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				$LOOP_MESSAGE
				INPUTS
				SELECTCASE RESULTS
					CASE "[确定]"
						WSTR:(K++) = 坦言不熟悉地形想同行。
						WSTR:(K++) = 少女不假思索地随意应允。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						WSTR:(K++) = 「无所谓啦，跟丢可不管哦」
						CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
						CALL 口上変数初期化
						WSTR:(K++) = 饮毕茶的灵梦轻盈浮空，对%CALLNAME:PLAYER%看都不看地飞向某处。
						WSTR:(K++) = 发愣的话真会被抛下，赶紧追赶吧。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						返答フラグ = 1
					CASE "[取消]"
						WSTR:(K++) = 不，再考虑下跟随对象。
						WSTR:(K++) = 表示暂不随行。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						WSTR:(K++) = 「怪人欸」
						WSTR:(K++) = 灵梦又开始品茶了……
						CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
						CALL 口上変数初期化
						返答フラグ = 2
					CASEELSE
						CLEARLINE 1
						REUSELASTLINE  
						GOTO LOOP_MESSAGE
				ENDSELECT
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
				;戦闘部分
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				;再視聴では通らない報酬部分
				IF 返答フラグ == 1
					CALL 接続ルート全開放処理(マス深度, マス分岐)
					CALL 踏破マス開放処理(15, 2)
					CALL 分岐マス選択セット(マス深度, マス分岐)
				ELSEIF 返答フラグ == 2
					;いいえ時、フラグをリセット
					LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:2")
					SETBIT LOCAL, 3
					CLEARBIT LOCAL, 2
					SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:2", LOCAL
				ENDIF
			ENDIF
			RFLAG:ダンジョン再視聴フラグ = 0
			CALL メッセージ欄表示用関数(,,,0)
			CALL 画面再描画
		ENDIF
ENDSELECT

@ダンジョンマス情報_幻想郷紅魔異変_14_6(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_魔理沙
#DIM 返答フラグ
マス深度 = 14
マス分岐 = 6

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = Ｂマーク
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "15_6")
	CASE "マスイベント"
		IF 分岐封印判定(条件_クリア済み, "14-2", "14-6")
			KSTR:(K++) = 该选项在迷宫通关前被锁定。
			;フラグをリセット
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:6")
			SETBIT LOCAL, 3
			CLEARBIT LOCAL, 2
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:6", LOCAL
			CALL メッセージ欄表示用関数(,,,0)
			CALL 画面再描画
		ELSE
			RFLAG:ダンジョン再視聴フラグ = 0
			IF 初来訪マス判定用フラグ
				;最初に訪れた時
				SETBIT RFLAG:ダンジョン再視聴フラグ, 0
				SETBIT RFLAG:ダンジョン再視聴フラグ, 1
				SETBIT RFLAG:ダンジョン再視聴フラグ, 10
			ELSE
				KSTR:(K++) = 追赶飞走的魔理沙。
				CALL 再視聴確認(1)
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
				;立ち絵リソース記録に必要な画像のリソースを生成する
				CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),100,,,1,1)
				立ち絵_魔理沙 = %立ち絵リソース記録%
				KSTR:(K++) = 要追赶飞走的魔理沙吗？
				KSTR:(K++) = BUTTON_[确定]
				KSTR:(K++) = BUTTON_[取消]
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				$LOOP_MESSAGE
				INPUTS
				SELECTCASE RESULTS
					CASE "[确定]"
						WSTR:(K++) = 人生地不熟，还是去追魔理沙吧。
						WSTR:(K++) = 朝着天空挥手追赶，魔理沙注意到后折返回来。
						WSTR:(K++) = 表明想同行后，少女爽快应允。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						WSTR:(K++) = 「无所谓啦，看你身手也不错」
						CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
						CALL 口上変数初期化
						WSTR:(K++) = 魔理沙维持着一米左右的飞行高度，配合%CALLNAME:PLAYER%一行的速度。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						WSTR:(K++) = 「那就出发吧，去找个能招待下午茶的洋馆」
						CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
						CALL 口上変数初期化
						返答フラグ = 1
					CASE "[取消]"
						WSTR:(K++) = 不，再考虑下跟随对象。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						返答フラグ = 2
					CASEELSE
						CLEARLINE 1
						REUSELASTLINE  
						GOTO LOOP_MESSAGE
				ENDSELECT
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
				;戦闘部分
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				;再視聴では通らない報酬部分
				IF 返答フラグ == 1
					CALL 接続ルート全開放処理(マス深度, マス分岐)
					CALL 踏破マス開放処理(15, 6)
					CALL 分岐マス選択セット(マス深度, マス分岐)
				ELSEIF 返答フラグ == 2
					;いいえ時、フラグをリセット
					LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:6")
					SETBIT LOCAL, 3
					CLEARBIT LOCAL, 2
					SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:6", LOCAL
				ENDIF
			ENDIF
			RFLAG:ダンジョン再視聴フラグ = 0
			CALL メッセージ欄表示用関数(,,,0)
			CALL 画面再描画
		ENDIF
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_15_2(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 15
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		CALL 接続ルート全開放処理(16, 2)
		ダンジョン現在位置:0 = 16
		ダンジョン現在位置:1 = 2
		ダンジョンマス画像URL_伏せ状態 = 壁_街
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_幻想郷紅魔異変_15_6(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 15
マス分岐 = 6

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		CALL 接続ルート全開放処理(16, 6)
		ダンジョン現在位置:0 = 16
		ダンジョン現在位置:1 = 6
		ダンジョンマス画像URL_伏せ状態 = 壁_街
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_16_2(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 16
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "18_2")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン背景画像 = 背景_紅い霧砂浜
		ダンジョン現在位置:0 = 15
		ダンジョン現在位置:1 = 2
		ダンジョンマス画像URL_伏せ状態 = 壁_森
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_幻想郷紅魔異変_16_6(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 16
マス分岐 = 6

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "19_6")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン背景画像 = 背景_紅い霧砂浜
		ダンジョン現在位置:0 = 15
		ダンジョン現在位置:1 = 6
		ダンジョンマス画像URL_伏せ状態 = 壁_森
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_18_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_霊夢
#DIMS 立ち絵_美鈴
マス深度 = 18
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "21_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		ダンジョン背景画像 = 背景_紅い霧砂浜
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 与灵梦共同迎战门卫红美铃。
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),100,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[华人小姑娘]红美铃"),101,,,1,1)
			立ち絵_美鈴 = %立ち絵リソース記録%
			WSTR:(K++) = 追随灵梦沿湖畔行进时，发现雾气愈发浓重。
			WSTR:(K++) = 与此同时，某座建筑……似乎是洋馆？高耸的围墙阴影映入眼帘。
			WSTR:(K++) = 继续靠近后，正门赫然显现。
			WSTR:(K++) = 身着类似伊迪尔瓦王国服饰的少女正站着打盹。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「呼噜…………」
			WSTR:(K++) = 幸福酣睡的模样令人不忍唤醒……
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"红发少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「看招」
			WSTR:(K++) = 灵梦毫不犹豫用御币敲醒了红发少女！
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「呜哇没睡没睡……咦，是客人吗？
			WSTR:(K++) = 　欢迎来到红魔馆」
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"红发少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 她甩着头似乎清醒过来。
			WSTR:(K++) = 向端正站姿的她询问红雾相关线索。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「哎、为什么知道…不、没、没有头绪啦。真困扰呢」
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"红发少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……这表情语气分明写着『有隐情』。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「切、暴露了吗……！为了大小姐，绝不能让入侵者通过！」
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"红发少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 虽然我们还没决定要入侵……
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「把普通巫女说成入侵者，真是恶劣的妖怪呢。
			WSTR:(K++) = 　来，赶紧一起收拾掉吧」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 红发少女袭来！
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv14_红发格斗少女
			戦闘時_特殊処理フラグ = 灵梦的助力_紅魔事変
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 16
				ダンジョン現在位置:1 = 2
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),100,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[华人小姑娘]红美铃"),101,,,1,1)
			立ち絵_美鈴 = %立ち絵リソース記録%
			WSTR:(K++) = 「可恶、背水一战了！」
			WSTR:(K++) = 抛下这句话，少女奔向洋馆。
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"红发少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「还贴心带路呢。赶紧前进吧」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 灵梦哼着小调轻松前行。
			WSTR:(K++) = 但洋馆内应该还有其他人员，很可能都是像刚才那位能战斗的角色。
			WSTR:(K++) = 必须小心行事。总不至于真有人单枪匹马摆什么『阵』吧。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_19_6(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_パチュリー
#DIMS 立ち絵_小悪魔
マス深度 = 19
マス分岐 = 6

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "21_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		ダンジョン背景画像 = 背景_紅魔館
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 与魔理沙共同在图书馆迎战帕秋莉。
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			ダンジョン背景画像 = 背景_紅い霧砂浜
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),100,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			WSTR:(K++) = 跟随魔理沙沿湖畔行进时，发现雾气愈发浓重。
			WSTR:(K++) = 与此同时，某座建筑……似乎是洋馆？高耸的围墙阴影映入眼帘。
			WSTR:(K++) = 继续靠近后，正门赫然显现。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 然而四周空无一人。
			WSTR:(K++) = 残留的战斗痕迹显示灵梦可能先来过了？
			WSTR:(K++) = 眺望门内的洋馆，从墙壁到屋顶都被漆成鲜红色。怎么看都很可疑。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「来打扰咯～顺便也干点打扰之外的事吧」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 魔理沙毫无顾忌地大步踏入洋馆。
			WSTR:(K++) = 从建筑风格判断显然与红雾有关，%CALLNAME:PLAYER%一行紧随魔理沙潜入洋馆。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			ダンジョン背景画像 = 背景_紅魔館
			WSTR:(K++) = 进入洋馆后感到莫名违和。
			WSTR:(K++) = ……虽说是大型建筑，但内部空间大得远超外观。
			WSTR:(K++) = 高阔的天花板与宽敞的走廊——足以让飞行少女们展开空战。
			WSTR:(K++) = 若在此遭遇军队般的敌人将毫无胜算。
			WSTR:(K++) = 必须谨慎前行……
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 继续前进却…………总觉得空无一人……
			WSTR:(K++) = 虽理解如此规模的洋馆人口密度低……
			WSTR:(K++) = 但放任入侵者不管真的没问题吗？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 在无人阻拦的闲逛中，飘来奇特香气。
			WSTR:(K++) = ……这是红茶香吗……？
			WSTR:(K++) = 似乎是从附近房间飘来的。
			WSTR:(K++) = 进去看看吧。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 推门而入，眼前是图书馆般的广阔空间。
			WSTR:(K++) = 幽暗潮湿……显然疏于打理。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「哇～好多书。等会顺点回去」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 会借给入侵者吗？正闲聊时发现旋转飞行的书本。
			WSTR:(K++) = 幻想乡万物皆可飞吗——刚这么想，书本开始蓄积光芒。恐怕是攻击前兆。
			WSTR:(K++) = ……现在可不是悠闲思考的时候！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「哦～正好闲着。一起轰飞它们吧！」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 书本使魔袭来！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:2:エネミー名 = Lv9_书本使魔
			敵BATTLE_STATE_STR:5:エネミー名 = Lv9_书本使魔
			敵BATTLE_STATE_STR:6:エネミー名 = Lv9_书本使魔
			戦闘時_特殊処理フラグ = 魔理沙的助力_紅魔事変
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 16
				ダンジョン現在位置:1 = 6
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),100,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[不动的大图书馆]帕秋莉・诺蕾姬"),101,,,1,1)
			立ち絵_パチュリー = %立ち絵リソース記録%
			WSTR:(K++) = 「那边的！别在我的图书馆撒野！」
			CALL メッセージ欄表示用関数(立ち絵_パチュリー,"紫色少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 击破书本后，紫发少女与身着黑色制服的恶魔风少女现身。
			WSTR:(K++) = 飘来红茶香气……是她刚才在饮用吗？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「你们是什么人？按理说应该安排了门卫」
			CALL メッセージ欄表示用関数(立ち絵_パチュリー,"紫色少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「没人在啦。不过刚才的书名可能是《门卫》」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 说明为消除红雾而来。
			WSTR:(K++) = 你是馆主吗？若是你在释放雾气请停止。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「哼。那就更不可能让你们见到蕾米————馆主了」
			CALL メッセージ欄表示用関数(立ち絵_パチュリー,"紫色少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……幻想乡的居民都这么血气方刚吗？
			WSTR:(K++) = 紫发少女突然发动袭击！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv14_紫色少女
			敵BATTLE_STATE_STR:4:エネミー名 = Lv10_恶魔风少女
			戦闘時_特殊処理フラグ = 魔理沙的助力_紅魔事変
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 16
				ダンジョン現在位置:1 = 6
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),100,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[不动的大图书馆]帕秋莉・诺蕾姬"),101,,,1,1)
			立ち絵_パチュリー = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[无名小恶魔]小恶魔"),102,,,1,1)
			立ち絵_小悪魔 = %立ち絵リソース記録%
			WSTR:(K++) = 「唔啾～……」
			CALL メッセージ欄表示用関数(立ち絵_パチュリー,"紫色少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「帕、帕秋莉大人！」
			CALL メッセージ欄表示用関数(立ち絵_小悪魔,"恶魔风少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 恶魔风少女抱起溃败的紫发少女逃走了。
			WSTR:(K++) = 或许能顺着踪迹找到线索，追上去吧。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「差不多要接近幕后黑手了？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_21_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_咲夜
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_霊夢
マス深度 = 21
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "23_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		ダンジョン背景画像 = 背景_紅魔館
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
			IF GETBIT(ダンジョン構造配列_幻想郷紅魔異変:14:2, 4)
				;霊夢ルート
				CLEARBIT RFLAG:ダンジョン再視聴フラグ, 4
			ELSE
				;魔理沙ルート
				SETBIT RFLAG:ダンジョン再視聴フラグ, 4
			ENDIF
		ELSE
			$再視聴表示
			IF GETBIT(ダンジョン構造配列_幻想郷紅魔異変:14:2, 4) && GETBIT(ダンジョン構造配列_幻想郷紅魔異変:14:6, 4)
				IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 4)
					;霊夢ルート
					KSTR:(K++) = 与灵梦共同迎战咲夜后和魔理沙会合。　　　_BUTTON_[切换路线]
				ELSE
					;魔理沙ルート
					KSTR:(K++) = 与魔理沙共同迎战咲夜后和灵梦会合。　　　_BUTTON_[切换路线]
				ENDIF
			ELSEIF GETBIT(ダンジョン構造配列_幻想郷紅魔異変:14:2, 4)
				;霊夢ルート
				CLEARBIT RFLAG:ダンジョン再視聴フラグ, 4
				KSTR:(K++) = 与灵梦共同迎战咲夜后和魔理沙会合。
			ELSE
				;魔理沙ルート
				SETBIT RFLAG:ダンジョン再視聴フラグ, 4
				KSTR:(K++) = 与魔理沙共同迎战咲夜后和灵梦会合。
			ENDIF
			CALL 再視聴確認(0, "[切换路线]")
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[完美而潇洒的从者]十六夜咲夜"),100,,,1,1)
			立ち絵_咲夜 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),101,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),102,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 4) == 0
				;霊夢ルート
				WSTR:(K++) = 在走廊行进时听到声响。
				WSTR:(K++) = 是之前的门卫少女吗？这次希望能好好沟通……
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「啊啊真是的，打扫进度被耽误！就算雇佣妖精当女仆也好啊！」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"女仆少女",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「你……看起来不像馆主呢」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 发现我们后，她瞬间闪现到眼前。
				WSTR:(K++) = 是类似瞬间移动的能力吗？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「你们是？大小姐的客人吗……不对，我不可能不知情。是入侵者吧。
				WSTR:(K++) = 　美铃到底在做什么……
				WSTR:(K++) = 　失礼了，我是这里的女仆长咲夜。
				WSTR:(K++) = 　这就用零秒时间清扫你们！」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「急性子的女仆呢。不过正合我意闹腾一番」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 女仆长咲夜正要发动攻击——
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「等等等等！总算赶上了。
				WSTR:(K++) = 　抢占戏份也是优秀魔女的必修课」
				CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「哎呀，这么快就追上来了」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 魔理沙以惊人速度从后方飞来加入战局。
				WSTR:(K++) = 那么重新开始。女仆长咲夜发动了袭击！
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			ELSE
				;魔理沙
				WSTR:(K++) = 追赶图书馆二人组时，走廊传来战斗声。
				WSTR:(K++) = 循声而去，发现灵梦正与女仆装少女交战！
				WSTR:(K++) = 魔理沙与我急忙赶去支援灵梦。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「哎呀，这么快就追上来了」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 女仆装少女警惕地拉开距离摆出架势。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「真是的，打扫工作都被耽误了！到处都是碍事者！」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"女仆少女",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「真失礼啊，我们可不只是来碍事的」
				CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「打扫的话……你看起来不擅长呢。那边那位倒是像模像样」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"女仆少女",,0)
				CALL 口上変数初期化
				IF 仕事レベル:PLAYER:1 >= 3
					WSTR:(K++) = 杂务方面确实算我的专长……
				ELSE
					WSTR:(K++) = 杂务方面还算有些心得……
				ENDIF
				WSTR:(K++) = 比起这个，能告诉我们红雾的事吗？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「雾气确实是我们释放的。既能遮阳，大小姐又喜欢昏暗环境」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"女仆少女",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 能否停止呢？雾气都飘到我们那边造成困扰了。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「这要由大小姐决定，入侵者休想见到她。
				WSTR:(K++) = 　失礼了，我是这里的女仆长咲夜。
				WSTR:(K++) = 　这就用零秒时间清扫你们！」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「也就是说，打倒你就能当女仆长咯？」
				CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 女仆长咲夜发动了袭击！
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv16_女仆长咲夜
			戦闘時_特殊処理フラグ = 霊夢と魔理沙的助力_紅魔事変
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 4) == 0
					ダンジョン現在位置:0 = 18
					ダンジョン現在位置:1 = 2
				ELSE
					ダンジョン現在位置:0 = 19
					ダンジョン現在位置:1 = 6
				ENDIF
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[完美而潇洒的从者]十六夜咲夜"),100,,,1,1)
			立ち絵_咲夜 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),101,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),102,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			WSTR:(K++) = 「挺强嘛……怪人们。和外界人类也不一样……」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 毕竟来自异世界——正要解释时，某处传来高亢的幼女声。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 『无妨。放行吧，咲夜』
			CALL メッセージ欄表示用関数(,"？？？",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「大小姐！？」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 『来自外界之外世界的客人，红魔馆理当率先迎接。
			WSTR:(K++) = 　不知这等贵客的鲜血是何滋味。真令人期待』
			CALL メッセージ欄表示用関数(,"？？？",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 扑棱棱的振翅声响起，明明身处室内却有蝙蝠群飞离。
			WSTR:(K++) = 咲夜叹息着转向我们。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「那么请允许我为各位贵客带路」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 拒绝的选项……似乎不存在。
			WSTR:(K++) = 既受邀请，推辞未免失礼。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「身子都暖和起来了。不需要再喝茶啦」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「倒是期待能有些甜馒头呢」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_23_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 23
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		CALL 接続ルート全開放処理(24, 4)
		ダンジョン現在位置:0 = 24
		ダンジョン現在位置:1 = 4
		ダンジョン背景画像 = 背景_紅魔館
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_24_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 24
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "26_4")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 23
		ダンジョン現在位置:1 = 4
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_26_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_咲夜
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_霊夢
#DIMS 立ち絵_レミリア
マス深度 = 26
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン_赤
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "30_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 与异变黑幕蕾米莉亚交战
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[永远鲜红的幼月]蕾米莉亚"),100,,,1,1)
			立ち絵_レミリア = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[完美而潇洒的从者]十六夜咲夜"),101,,,1,1)
			立ち絵_咲夜 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),102,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),103,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			WSTR:(K++) = 被引领至一处宽阔露台。
			WSTR:(K++) = 身着白色礼裙的幼女正在啜饮某种红色茶饮。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「欢迎光临。
			WSTR:(K++) = 　我是红魔馆之主，蕾米莉亚・斯卡雷特。
			WSTR:(K++) = 　阁下是？」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"？？？",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 自报家门后，她——蕾米莉亚颔首起身。
			WSTR:(K++) = 身形娇小。
			WSTR:(K++) = 约莫人类十岁孩童的身高？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 不过，实际年龄显然与外表不符……实力也绝非表面所见。
			WSTR:(K++) = 肉眼可见的磅礴魔力正在涡旋……
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「那么？专程造访红魔馆所为何事？」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"蕾米莉亚",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 异界之门溢出的雾气已波及我方世界。
			WSTR:(K++) = 我方不愿断绝与幻想乡这片潜在客源丰饶之地的交流。
			WSTR:(K++) = ……能否以一年份度假村优待券达成协议？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「度假村？哦……优待券？哼，真会说笑，莫非在经营产业？」
			WSTR:(K++) = 点头确认后，蕾米莉亚露出饶有兴致的表情。
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"蕾米莉亚",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「好吧，一年份优待券本小姐就笑纳了。
			WSTR:(K++) = 　雾气方面也会让馆内魔法使处理，避免蔓延至贵方世界」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"蕾米莉亚",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 希望能彻底终止，但恐怕难以如愿吧。
			WSTR:(K++) = 作为外来者也不便过于强硬……
			WSTR:(K++) = 正踌躇间，随行的两位少女挺身而出。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「这样可不行呢」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「请立刻停止红雾」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……蕾米莉亚明显露出不悦神色。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「咲夜，那两人交给你了」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"蕾米莉亚",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「遵命」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 咲夜身形消散的瞬间，灵梦与魔理沙也从原地消失。
			WSTR:(K++) = 数秒后，高空传来激战声……
			WSTR:(K++) = 蕾米莉亚重整仪态，优雅颔首。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「那么，这样如何。
			WSTR:(K++) = 　本小姐会停止红雾。
			WSTR:(K++) = 　然后——现在要取你性命」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"蕾米莉亚",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「若你能幸存，此事便了结。本小姐会以普通游客身份造访度假区。
			WSTR:(K++) = 　若你殒命，本小姐会将你转化为尸生人（僵尸），将度假区收作私人领地」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"蕾米莉亚",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……度假村被侵占可伤脑筋啊。
			WSTR:(K++) = 蕾米莉亚舒展双翼。
			WSTR:(K++) = 红雾撕裂处，猩红满月显露真容。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「既然月色如此殷红——」
			WSTR:(K++) = 
			WSTR:(K++) = ——当叩问之夜降临，便以鲜血相迎吧？
			WSTR:(K++) = 当造访之夜来临，自当盛情款待——
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"蕾米莉亚",,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv18_吸血鬼蕾米莉亚
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 24
				ダンジョン現在位置:1 = 4
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT





@ダンジョンマス情報_幻想郷紅魔異変_30_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_咲夜
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_霊夢
#DIMS 立ち絵_レミリア
マス深度 = 30
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 成功解决异变，获得度假村新客源。
			CALL 再視聴確認(1)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[永远鲜红的幼月]蕾米莉亚"),100,,,1,1)
			立ち絵_レミリア = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[完美而潇洒的从者]十六夜咲夜"),101,,,1,1)
			立ち絵_咲夜 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通的魔法使]雾雨魔理沙"),102,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[乐园的可爱巫女]博丽灵梦"),103,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			WSTR:(K++) = 调整异界之门。
			WSTR:(K++) = 如今与幻想乡的通道已稳定，即便红雾再生也不会流向我方世界。
			WSTR:(K++) = 由于装置由我方设置，管理权自然归属我方，但若能偶尔关照则不胜感激——
			WSTR:(K++) = 灵梦等人点头应允，继续品茶。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「经营方面我们会妥善处理……话说，我也能去那个度假区吗？
			WSTR:(K++) = 　虽然手头没什么『钱』的样子…」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「咦？你这家伙有钱吗？连参拜客的香火钱都没有吧？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「香火钱虽无，但积攒了不少善意哦」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……虽说卢比结算最为理想……
			WSTR:(K++) = 但幻想乡似乎也存在空中通用的贵重物品，以及运用完全不同理论制造的物品。
			WSTR:(K++) = 若能带来此类物品，可酌情通融。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「是吗？那等善意积分用尽就去叨扰咯」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"灵梦",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「不如现在就跟着回去如何？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 无视开始斗嘴的红白与黑白组合。
			WSTR:(K++) = 阳光下，执洋伞的幼女——蕾米莉亚携女仆咲夜款款而来。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「前方就是度假村？
			WSTR:(K++) = 　要不要腾出日程组织员工旅行呢？」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"蕾米莉亚",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「大小姐，我们并非员工……
			WSTR:(K++) = 　准确而言应是红魔馆访问团」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「说法有差吗？」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"蕾米莉亚",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……至此，度假区宣传已覆盖幻想乡居民。
			WSTR:(K++) = 邀请蕾米莉亚一行造访并传播口碑或许不错。
			WSTR:(K++) = 期待重新制定经营计划。
			WSTR:(K++) = 当务之急是调研幻想乡居民喜好再返程。
			WSTR:(K++) = 总不至于全是食人族吧。大概……
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = [乐园的可爱巫女]博丽灵梦开始造访度假村了！
			WSTR:(K++) = [普通的魔法使]雾雨魔理沙开始造访度假村了！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = [华人小姑娘]红美铃开始造访度假村了！
			WSTR:(K++) = [无名小恶魔]小恶魔开始造访度假村了！
			WSTR:(K++) = [不动的大图书馆]帕秋莉・诺蕾姬开始造访度假村了！
			WSTR:(K++) = [完美而潇洒的从者]十六夜咲夜开始造访度假村了！
			WSTR:(K++) = [永远鲜红的幼月]蕾米莉亚开始造访度假村了！
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CFLAG:(キャラ検索("[乐园的可爱巫女]博丽灵梦")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[普通的魔法使]雾雨魔理沙")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[华人小姑娘]红美铃")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[无名小恶魔]小恶魔")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[不动的大图书馆]帕秋莉・诺蕾姬")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[完美而潇洒的从者]十六夜咲夜")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[永远鲜红的幼月]蕾米莉亚")):招待不可フラグ = 0
			ダンジョン終了状況 = 踏破達成
			ダンジョンクリアフラグ_幻想郷紅魔異変 = 1
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT

