
;----------------------------------------------------
;キャラ固有コマンド処理
;----------------------------------------------------
;コマンド名
;----------------------------------------------------
@CHARACOMNAME371_2
#FUNCTIONS
	TSTR:コマンド名受渡 = 身外身之术

;===================================================
;コマンドタイプ
;===================================================
@COMTYPE_371_2
#FUNCTION
TFLAG:コマンドタイプ受渡 = COMTYPE("うふふ")


@COM_TOOLTIP_371_2
LOCALS = <br>■身外身之术<br>
LOCALS += "创造自身分身并各自活动的术式。<br>在嘿咻期间，能表现得宛如有多人存在般。<br>分身获得的经验会回馈本体。"
LOCALS += "<br>指令类型：嘿咻<br>获取来源：无"
LOCALS += "<br>专属经验值：无<br>"
TSTR:ツールチップ受渡 = %LOCALS%

@CHARACOM371_2

ADDCOPYCHARA TARGET
FOR LOCAL, 0, 分身最大数
	IF 分身登録:LOCAL:0 < 1
		分身登録:LOCAL:0 = CHARANUM - 1
		分身登録:LOCAL:1 = TARGET
		NAME:(分身登録:LOCAL:0) = %NAME表示((分身登録:LOCAL:0))%%TOFULL(TOSTR(LOCAL + 2))%
		CALLNAME:(分身登録:LOCAL:0) = %CALLNAME:(分身登録:LOCAL:0)%%TOFULL(TOSTR(LOCAL + 2))%
		TALENT:(分身登録:LOCAL:0):分身 = 1
		CFLAG:(分身登録:LOCAL:0):人物番号 = -1
		FOR LOCAL:1, 101, 111
			;部位占有を解放
			TEQUIP:(分身登録:LOCAL:0):(LOCAL:1) = 0
		NEXT
		FOR LOCAL:1, 0, 200
			;分身時点でのEXPを保存
			分身EXP保存:LOCAL:(LOCAL:1) = EXP:TARGET:(LOCAL:1)
		NEXT
		BREAK
	ENDIF
NEXT
CALL SORT_CHARALIST()

RETURN 1

;-------------------------------------------------
;実行判定
;-------------------------------------------------
@COM_ABLE371_2
;実行判定
SIF SAVESTR:ゲームフェイズ管理 != "通常モード"
	RETURN 0
;一括管理
SIF GLOBAL_COMABLE(371)
	RETURN RESULT

;隠密時はバグるのでダメ
SIF CFLAG:PLAYER:隠密
	RETURN 0

;分身は分身を出せない
FOR LOCAL, 0, 分身最大数
	IF 分身登録:LOCAL:0 == TARGET
		RETURN 0
	ENDIF
NEXT

;３体まで
LOCAL:1 = 0
FOR LOCAL, 0, 分身最大数
	IF 分身登録:LOCAL:1 == TARGET
		LOCAL:1 ++
	ENDIF
NEXT
SIF LOCAL:1 >= 3
	RETURN 0

RETURN 1

;-------------------------------------------------
;実行時メッセージ
;-------------------------------------------------
@MESSAGE_COM371_2
PRINTFORML 安琪拉用身外身之术制造了分身。
